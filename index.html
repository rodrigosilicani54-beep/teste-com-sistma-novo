<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Agendamento - Cl√≠nica ABA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="internal-ai.js"></script>
    <style>
        .appointment-slot {
            min-height: 45px;
            transition: all 0.3s ease;
        }
        .appointment-card {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .appointment-card:hover {
            transform: scale(1.02);
        }
        .blocked-slot {
            background: repeating-linear-gradient(
                45deg,
                #f3f4f6,
                #f3f4f6 10px,
                #e5e7eb 10px,
                #e5e7eb 20px
            );
        }
        .professional-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .professional-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .time-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            font-size: 11px;
        }
        .time-slot {
            background: white;
            padding: 4px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .day-header {
            background: #f3f4f6;
            font-weight: bold;
            padding: 8px 4px;
            text-align: center;
            font-size: 12px;
        }
        .time-label {
            background: #f9fafb;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .conflict-highlight {
            border: 2px solid #ef4444 !important;
            background: #fef2f2 !important;
        }
        .suggestion-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .suggestion-item:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto p-3">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Sistema de Agendamento - Cl√≠nica ABA</h1>
                </div>
                <!-- Admin Button (will be shown only for admin users) -->
                <button id="adminClearBtn" onclick="showAdminClearModal()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded font-medium transition-colors text-sm flex items-center gap-1" style="display: none;">
                    üóëÔ∏è Limpar Tudo (Admin)
                </button>
            </div>
            <p class="text-gray-600 mb-3 text-sm">Gest√£o completa de agendamentos por especialidade</p>
            
            <!-- Legenda de Cores -->
            <div class="flex flex-wrap gap-2 mb-3 text-xs">
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-orange-500 rounded"></div>
                    <span>Atendimento Cl√≠nica</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-pink-500 rounded"></div>
                    <span>An√°lise</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-blue-500 rounded"></div>
                    <span>Discuss√£o de Caso</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-green-500 rounded"></div>
                    <span>CLS</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-yellow-200 rounded border border-gray-300"></div>
                    <span>Supervis√£o</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-purple-500 rounded"></div>
                    <span>Treinamento/Reuni√£o</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-yellow-400 rounded"></div>
                    <span>Orienta√ß√£o Parental</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-gray-400 rounded"></div>
                    <span>Bloqueio/Deslocamento</span>
                </div>
            </div>

            <!-- User Info and Logout -->
            <div id="userInfo" class="mb-3 p-2 bg-green-50 rounded border border-green-200 text-sm" style="display: none;">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-green-700 font-medium">üë§ Logado como:</span>
                        <span id="currentUserName" class="text-green-800 font-bold"></span>
                        <span id="currentUserPermission" class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-medium"></span>
                    </div>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800 text-xs underline">
                        üö™ Sair
                    </button>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="flex flex-wrap gap-2">
                <button onclick="showProfessionalsView()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded font-medium transition-colors text-sm">
                    üìã Ver Profissionais
                </button>
                <button id="addProfessionalBtn" onclick="openProfessionalModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded font-medium transition-colors text-sm">
                    üë®‚Äç‚öïÔ∏è Cadastrar Profissional
                </button>
                <button id="newAppointmentBtn" onclick="openScheduleModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded font-medium transition-colors text-sm">
                    üìÖ Novo Agendamento
                </button>
                <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded font-medium transition-colors text-sm">
                    üìä Exportar Excel
                </button>
                <button onclick="showWeeklyView()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded font-medium transition-colors text-sm">
                    üìÜ Vis√£o Semanal
                </button>
                <button id="rescheduleBtn" onclick="openRescheduleModal()" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-1.5 rounded font-medium transition-colors text-sm">
                    üîÑ Reagendamento Inteligente
                </button>
                <button id="userManagementBtn" onclick="openUserManagementModal()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded font-medium transition-colors text-sm" style="display: none;">
                    üë• Gerenciar Usu√°rios
                </button>
                <button onclick="showRoomsView()" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1.5 rounded font-medium transition-colors text-sm">
                    üè¢ Salas
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="mainContent">
            <!-- Weekly Schedule View -->
            <div id="weeklyView" class="bg-white rounded-lg shadow-lg p-3">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-3">
                    <h2 class="text-lg font-bold text-gray-800">Agenda Semanal</h2>
                    
                    <!-- Compact Controls -->
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="professionalSearch" 
                                placeholder="Digite para buscar profissional..." 
                                oninput="searchProfessional()"
                                onfocus="showProfessionalDropdown()"
                                class="px-3 py-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-500 w-full sm:w-48 pr-8"
                            >
                            <button onclick="clearProfessionalFilter()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-sm">
                                ‚úï
                            </button>
                            <!-- Professional Dropdown -->
                            <div id="professionalDropdown" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-b shadow-lg z-50 max-h-48 overflow-y-auto" style="display: none;">
                                <!-- Professional options will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Selected Professional Info -->
                <div id="selectedProfessionalInfo" class="mb-3 p-2 bg-blue-50 rounded border border-blue-200 text-sm" style="display: none;">
                    <div class="flex items-center gap-2">
                        <span class="text-blue-700 font-medium">üë®‚Äç‚öïÔ∏è Visualizando agenda de:</span>
                        <span id="selectedProfessionalName" class="text-blue-800 font-bold"></span>
                        <button onclick="clearProfessionalFilter()" class="ml-auto text-blue-600 hover:text-blue-800 text-xs underline">
                            Ver todos os profissionais
                        </button>
                    </div>
                </div>
                
                <div id="scheduleGrid" class="time-grid"></div>
            </div>

            <!-- Professionals View -->
            <div id="professionalsView" class="bg-white rounded-lg shadow-lg p-6" style="display: none;">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Profissionais Cadastrados</h2>
                    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                        <!-- Search Filter -->
                        <div class="relative">
                            <input 
                                type="text" 
                                id="professionalsSearchFilter" 
                                placeholder="üîç Buscar por nome..." 
                                oninput="filterProfessionalsList()"
                                class="px-4 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 w-full sm:w-64 pr-10"
                            >
                            <button onclick="clearProfessionalsFilter()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-sm">
                                ‚úï
                            </button>
                        </div>
                        <button onclick="showWeeklyView()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg whitespace-nowrap">
                            ‚Üê Voltar √† Agenda
                        </button>
                    </div>
                </div>
                
                <!-- Results Counter -->
                <div id="professionalsResultsCounter" class="mb-4 text-sm text-gray-600" style="display: none;">
                    <span id="professionalsResultsText"></span>
                </div>
                
                <div id="professionalsList" class="space-y-6"></div>
            </div>

            <!-- Rooms View -->
            <div id="roomsView" class="bg-white rounded-lg shadow-lg p-6" style="display: none;">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">üè¢ Ocupa√ß√£o das Salas</h2>
                    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                        <button onclick="showWeeklyView()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg whitespace-nowrap">
                            ‚Üê Voltar √† Agenda
                        </button>
                    </div>
                </div>
                
                <!-- Simple Controls -->
                <div class="mb-6 bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800">üìä Visualiza√ß√£o das Salas</h3>
                        <div class="flex gap-2">
                            <button onclick="showRoomTableView()" id="tableViewBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                                üìä Ver Tabela
                            </button>
                            <button onclick="showRoomCardsView()" id="cardsViewBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                                üìã Ver Cards Compactos
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Room Status Legend -->
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-green-500 rounded"></div>
                            <span>Sala Livre</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-red-500 rounded"></div>
                            <span>Sala Ocupada</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-gray-300 rounded"></div>
                            <span>Sem Dados</span>
                        </div>
                    </div>
                </div>
                
                <!-- Results Counter -->
                <div id="roomsResultsCounter" class="mb-4 text-sm text-gray-600" style="display: none;">
                    <span id="roomsResultsText"></span>
                </div>
                
                <div id="roomsList" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Professional Registration -->
    <div id="professionalModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Cadastrar Profissional</h3>
            <form id="professionalForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Nome Completo</label>
                    <input type="text" id="profName" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Especialidade</label>
                    <select id="profSpecialty" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Selecione...</option>
                        <option value="Psic√≥logo">Psic√≥logo</option>
                        <option value="Analista do Comportamento">Analista do Comportamento</option>
                        <option value="Fonoaudi√≥logo">Fonoaudi√≥logo</option>
                        <option value="Terapeuta Ocupacional">Terapeuta Ocupacional</option>
                        <option value="Supervisor">Supervisor</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">CRP/Registro</label>
                    <input type="text" id="profRegistration" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium">
                        Cadastrar
                    </button>
                    <button type="button" onclick="closeProfessionalModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Export -->
    <div id="exportModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-blue-800">üìä Exportar/Importar Planilha</h3>
            
            <!-- Export Section -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h4 class="text-lg font-semibold mb-3 text-blue-700">üì§ Exportar Dados</h4>
                <p class="text-gray-700 mb-3">Baixe todos os agendamentos em formato Excel:</p>
                <button onclick="downloadExcel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                    üì• Baixar Planilha Excel
                </button>
            </div>

            <!-- Import Section -->
            <div class="mb-6 p-4 bg-green-50 rounded-lg">
                <h4 class="text-lg font-semibold mb-3 text-green-700">üì§ Importar Dados</h4>
                <p class="text-gray-700 mb-3">Fa√ßa upload de uma planilha Excel para importar agendamentos:</p>
                <div class="mb-3">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" class="w-full p-2 border rounded-lg">
                </div>
                <button onclick="importExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                    üì§ Importar Planilha
                </button>
            </div>

            <!-- Import Rooms Section -->
            <div class="mb-6 p-4 bg-teal-50 rounded-lg">
                <h4 class="text-lg font-semibold mb-3 text-teal-700">üè¢ Importar Separa√ß√£o de Salas</h4>
                <p class="text-gray-700 mb-3">Fa√ßa upload da planilha "Separa√ß√£o de Salas.xlsx" para visualizar a ocupa√ß√£o das salas:</p>
                <div class="mb-3">
                    <input type="file" id="roomsExcelFile" accept=".xlsx,.xls" class="w-full p-2 border rounded-lg">
                </div>
                <button onclick="importRoomsExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium">
                    üè¢ Importar Separa√ß√£o de Salas
                </button>
            </div>

            <!-- Rules Section -->
            <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
                <h4 class="text-lg font-semibold mb-3 text-yellow-700">üìã Regras da Planilha</h4>
                <div class="text-sm text-gray-700 space-y-2">
                    <h5 class="font-semibold text-gray-800">Formato de Exporta√ß√£o:</h5>
                    <ul class="list-disc list-inside space-y-1 ml-2">
                        <li>Data no formato DD/MM/AAAA</li>
                        <li>Hor√°rio no formato HH:MM</li>
                        <li>Dados ordenados por data e hor√°rio</li>
                        <li>Todas as colunas com largura otimizada</li>
                    </ul>
                    
                    <h5 class="font-semibold text-gray-800 mt-4">Formato de Importa√ß√£o:</h5>
                    <ul class="list-disc list-inside space-y-1 ml-2">
                        <li>Arquivo deve ser .xlsx ou .xls</li>
                        <li>Primeira linha deve conter os cabe√ßalhos</li>
                        <li>Colunas obrigat√≥rias: Data, Hor√°rio, Profissional, Tipo de Atendimento, Cliente</li>
                        <li>Data deve estar no formato DD/MM/AAAA</li>
                        <li>Hor√°rio deve estar no formato HH:MM</li>
                        <li>Profissionais devem estar previamente cadastrados</li>
                    </ul>
                    
                    <h5 class="font-semibold text-gray-800 mt-4">Tipos de Atendimento V√°lidos:</h5>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <span class="bg-orange-100 px-2 py-1 rounded text-xs">Atendimento Cl√≠nica</span>
                        <span class="bg-pink-100 px-2 py-1 rounded text-xs">An√°lise</span>
                        <span class="bg-blue-100 px-2 py-1 rounded text-xs">Discuss√£o de Caso</span>
                        <span class="bg-green-100 px-2 py-1 rounded text-xs">CLS</span>
                        <span class="bg-yellow-100 px-2 py-1 rounded text-xs">Supervis√£o</span>
                        <span class="bg-purple-100 px-2 py-1 rounded text-xs">Treinamento</span>
                        <span class="bg-yellow-200 px-2 py-1 rounded text-xs">Orienta√ß√£o Parental</span>
                    </div>
                    
                    <h5 class="font-semibold text-gray-800 mt-4">üè¢ Formato "Separa√ß√£o de Salas.xlsx":</h5>
                    <ul class="list-disc list-inside space-y-1 ml-2 text-sm">
                        <li><strong>Arquivo:</strong> "Separa√ß√£o de Salas.xlsx" obrigat√≥rio</li>
                        <li><strong>Aba:</strong> "Planilha1" obrigat√≥ria</li>
                        <li><strong>A3 a A48:</strong> Nomes das salas (46 salas)</li>
                        <li><strong>B3 a B629:</strong> Hor√°rios (formato HH:MM ou HHh)</li>
                        <li><strong>C1, E1, G1, I1, K1, M1:</strong> Dias da semana</li>
                        <li><strong>Colunas C,E,G,I,K,M:</strong> Pacientes</li>
                        <li><strong>Colunas D,F,H,J,L,N:</strong> Profissionais</li>
                        <li><strong>Status:</strong> Ocupado se paciente OU profissional preenchido</li>
                        <li><strong>Exibi√ß√£o:</strong> Tabela HTML com todas as informa√ß√µes</li>
                        <li><strong>‚ö†Ô∏è IMPORTANTE:</strong> Apenas visualiza√ß√£o - n√£o afeta agendamentos</li>
                    </ul>
                </div>
            </div>

            <!-- Warning Section -->
            <div class="mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
                <h4 class="text-lg font-semibold mb-2 text-red-700">‚ö†Ô∏è Importante</h4>
                <ul class="text-sm text-red-700 space-y-1">
                    <li>‚Ä¢ A importa√ß√£o substituir√° todos os agendamentos existentes</li>
                    <li>‚Ä¢ Fa√ßa backup dos dados antes de importar</li>
                    <li>‚Ä¢ Verifique se todos os profissionais est√£o cadastrados</li>
                    <li>‚Ä¢ Dados inv√°lidos ser√£o ignorados</li>
                </ul>
            </div>

            <div class="flex gap-3">
                <button onclick="closeExportModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Import Confirmation Modal -->
    <div id="importConfirmModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 shadow-xl">
            <h3 class="text-xl font-bold mb-4 text-green-700">‚úÖ Importa√ß√£o Processada</h3>
            <div class="mb-4 space-y-2">
                <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                    <span class="font-medium">Novos Profissionais:</span>
                    <span id="newProfessionalsCount" class="bg-blue-600 text-white px-2 py-1 rounded text-sm">0</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                    <span class="font-medium">Total de Agendamentos:</span>
                    <span id="totalAppointmentsCount" class="bg-green-600 text-white px-2 py-1 rounded text-sm">0</span>
                </div>
            </div>
            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <p class="text-sm text-yellow-800">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Aceitar substituir√° todos os agendamentos atuais pelos dados importados.
                </p>
            </div>
            <div class="flex gap-3">
                <button onclick="confirmImport()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium">
                    ‚úÖ Aceitar
                </button>
                <button onclick="cancelImport()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium">
                    ‚ùå Recusar
                </button>
            </div>
        </div>
    </div>

    <!-- Room Import Confirmation Modal -->
    <div id="roomImportConfirmModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 shadow-xl">
            <h3 class="text-xl font-bold mb-4 text-teal-700">üè¢ Importa√ß√£o de Salas Processada</h3>
            <div class="mb-4 space-y-2">
                <div class="flex justify-between items-center p-2 bg-teal-50 rounded">
                    <span class="font-medium">Salas Encontradas:</span>
                    <span id="roomsFoundCount" class="bg-teal-600 text-white px-2 py-1 rounded text-sm">0</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                    <span class="font-medium">Hor√°rios Processados:</span>
                    <span id="roomSlotsCount" class="bg-blue-600 text-white px-2 py-1 rounded text-sm">0</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                    <span class="font-medium">Ocupa√ß√µes Registradas:</span>
                    <span id="roomOccupanciesCount" class="bg-green-600 text-white px-2 py-1 rounded text-sm">0</span>
                </div>
            </div>
            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <p class="text-sm text-yellow-800">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Aceitar substituir√° todos os dados de salas atuais pelos dados importados.
                </p>
            </div>
            <div class="flex gap-3">
                <button onclick="confirmRoomImport()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white py-2 rounded-lg font-medium">
                    ‚úÖ Aceitar
                </button>
                <button onclick="cancelRoomImport()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium">
                    ‚ùå Recusar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Scheduling -->
    <div id="scheduleModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <h3 id="scheduleModalTitle" class="text-xl font-bold mb-4">Novo Agendamento</h3>
            <form id="scheduleForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Profissional</label>
                    <select id="scheduleProfessional" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Selecione o profissional...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Tipo de Atendimento</label>
                    <select id="scheduleType" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Selecione...</option>
                        <option value="clinica">Atendimento Cl√≠nica</option>
                        <option value="analise">An√°lise</option>
                        <option value="discussao">Discuss√£o de Caso</option>
                        <option value="cls">CLS</option>
                        <option value="supervisao">Supervis√£o</option>
                        <option value="treinamento">Treinamento</option>
                        <option value="orientacao">Orienta√ß√£o Parental</option>
                        <option value="reuniao">Reuni√£o</option>
                        <option value="bloqueio">Bloqueio</option>
                        <option value="deslocamento">Deslocamento</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Data</label>
                    <input type="date" id="scheduleDate" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Hor√°rio</label>
                    <input type="time" id="scheduleTime" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Dura√ß√£o (minutos)</label>
                    <select id="scheduleDuration" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="30">30 minutos</option>
                        <option value="60" selected>60 minutos</option>
                        <option value="90">90 minutos</option>
                        <option value="120">120 minutos</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Cliente/Paciente</label>
                    <input type="text" id="scheduleClient" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Observa√ß√µes</label>
                    <textarea id="scheduleNotes" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                </div>
                <div class="flex gap-3">
                    <button type="submit" id="scheduleSubmitBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium">
                        Agendar
                    </button>
                    <button type="button" onclick="closeScheduleModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">
                        Cancelar
                    </button>
                    <button type="button" id="deleteAppointmentBtn" onclick="deleteCurrentAppointment()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium" style="display: none;">
                        üóëÔ∏è
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflictModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-red-700">‚ö†Ô∏è Conflito de Hor√°rio Detectado</h3>
            
            <!-- Conflict Details -->
            <div id="conflictDetails" class="mb-6">
                <!-- Conflict information will be populated here -->
            </div>

            <!-- Resolution Options -->
            <div id="conflictResolutionOptions" class="mb-6">
                <!-- Resolution options will be populated here -->
            </div>

            <div class="flex gap-3">
                <button onclick="closeConflictModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">
                    Cancelar
                </button>
                <button id="forceCreateBtn" onclick="forceCreateAppointment()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium" style="display: none;">
                    ‚ö†Ô∏è For√ßar Cria√ß√£o
                </button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: flex;">
        <div class="bg-white rounded-lg p-8 w-full max-w-md mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">üè• Cl√≠nica ABA</h2>
                <p class="text-gray-600">Sistema de Agendamento</p>
            </div>
            
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2 text-gray-700">üë§ Usu√°rio</label>
                    <input type="text" id="loginUsername" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required placeholder="Digite seu usu√°rio">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-700">üîí Senha</label>
                    <input type="password" id="loginPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required placeholder="Digite sua senha">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium text-lg transition-colors">
                    üö™ Entrar
                </button>
            </form>
            

        </div>
    </div>

    <!-- User Management Modal -->
    <div id="userManagementModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-blue-700">üë• Gerenciamento de Usu√°rios</h3>
            
            <!-- Add User Section -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h4 class="text-lg font-semibold mb-3 text-blue-800">‚ûï Adicionar Novo Usu√°rio</h4>
                <form id="addUserForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nome Completo</label>
                        <input type="text" id="newUserName" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Nome de Usu√°rio</label>
                        <input type="text" id="newUserUsername" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Senha</label>
                        <input type="password" id="newUserPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">N√≠vel de Acesso</label>
                        <select id="newUserPermission" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Selecione...</option>
                            <option value="view">üëÅÔ∏è Apenas Visualizar</option>
                            <option value="edit">‚úèÔ∏è Visualizar e Editar</option>
                            <option value="admin">üëë Administrador</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium">
                            ‚ûï Adicionar Usu√°rio
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Sync Section -->
            <div class="mb-6 p-4 bg-green-50 rounded-lg">
                <h4 class="text-lg font-semibold mb-3 text-green-800">üîÑ Sincroniza√ß√£o com Google Sheets</h4>
                <p class="text-sm text-green-700 mb-3">
                    Sincronize todos os usu√°rios cadastrados com a planilha do Google Sheets.
                    <br>
                    <strong>Colunas:</strong> ID | Nome Completo | Nome de Usu√°rio | Senha | N√≠vel de Acesso | Data de Cria√ß√£o
                </p>
                <button onclick="syncAllUsersToGoogleSheets()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium">
                    üîÑ Sincronizar com Google Sheets
                </button>
            </div>

            <!-- Users List -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">üë• Usu√°rios Cadastrados</h4>
                <div id="usersList" class="space-y-3">
                    <!-- Users will be populated here -->
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeUserManagementModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Smart Reschedule Modal -->
    <div id="rescheduleModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-amber-700">üîÑ Reagendamento Inteligente</h3>
            
            <!-- Step 1: Select Appointment -->
            <div id="rescheduleStep1" class="mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">1. Selecione o agendamento para reagendar:</h4>
                <div class="mb-4">
                    <input type="text" id="rescheduleSearch" placeholder="Digite o nome do cliente ou profissional..." 
                           oninput="searchAppointmentsForReschedule()" 
                           class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-amber-500">
                </div>
                <div id="appointmentsList" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Appointments will be populated here -->
                </div>
            </div>

            <!-- Step 2: New Date/Time -->
            <div id="rescheduleStep2" class="mb-6" style="display: none;">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">2. Nova data e hor√°rio desejados:</h4>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nova Data</label>
                        <input type="date" id="rescheduleNewDate" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Novo Hor√°rio</label>
                        <input type="time" id="rescheduleNewTime" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
                <button onclick="checkRescheduleOptions()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-medium">
                    üîç Verificar Disponibilidade
                </button>
            </div>

            <!-- Step 3: Conflict Resolution -->
            <div id="rescheduleStep3" class="mb-6" style="display: none;">
                <div id="rescheduleResults">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeRescheduleModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">
                    Fechar
                </button>
                <button id="resetRescheduleBtn" onclick="resetRescheduleModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium" style="display: none;">
                    üîÑ Nova Consulta
                </button>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let professionals = JSON.parse(localStorage.getItem('professionals')) || [];
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let rooms = JSON.parse(localStorage.getItem('rooms')) || [];
        let roomSchedule = JSON.parse(localStorage.getItem('roomSchedule')) || [];
        let currentWeekStart = new Date();
        let selectedProfessionalId = null; // For filtering by professional
        let editingAppointmentId = null; // For editing appointments
        let isAdminUser = false; // Will be set to true when admin login is implemented
        let selectedAppointmentForReschedule = null; // For reschedule modal
        let currentUser = null; // Current logged in user
        let userPermissions = { canEdit: false, canView: false }; // Current user permissions
        let tempRoomImportData = null; // For room import confirmation
        
        // Set current week to Monday
        const today = new Date();
        const dayOfWeek = today.getDay();
        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        currentWeekStart.setDate(today.getDate() + daysToMonday);
        currentWeekStart.setHours(0, 0, 0, 0);

        // Service type colors
        const serviceColors = {
            'clinica': 'bg-orange-500',
            'analise': 'bg-pink-500',
            'discussao': 'bg-blue-500',
            'cls': 'bg-green-500',
            'supervisao': 'bg-yellow-200 border border-gray-300 text-gray-800',
            'treinamento': 'bg-purple-500',
            'orientacao': 'bg-yellow-400',
            'reuniao': 'bg-purple-500',
            'bloqueio': 'bg-gray-400',
            'deslocamento': 'bg-gray-400'
        };

        // Filter functions for professionals list
        function filterProfessionalsList() {
            renderProfessionalsList();
        }

        function clearProfessionalsFilter() {
            document.getElementById('professionalsSearchFilter').value = '';
            renderProfessionalsList();
        }

        function updateProfessionalsResultsCounter(filtered, total) {
            const counter = document.getElementById('professionalsResultsCounter');
            const text = document.getElementById('professionalsResultsText');
            
            if (filtered === total) {
                counter.style.display = 'none';
            } else {
                counter.style.display = 'block';
                text.textContent = `Mostrando ${filtered} de ${total} profissionais`;
            }
        }

        // Conflict Resolution System
        let pendingAppointmentData = null;
        let pendingIsEditing = false;

        function showConflictResolutionDialog(conflicts, appointmentData, professional, isEditing) {
            pendingAppointmentData = appointmentData;
            pendingIsEditing = isEditing;
            
            const modal = document.getElementById('conflictModal');
            const detailsDiv = document.getElementById('conflictDetails');
            const optionsDiv = document.getElementById('conflictResolutionOptions');
            
            const formattedDate = new Date(appointmentData.date + 'T00:00:00').toLocaleDateString('pt-BR');
            const dayName = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'][new Date(appointmentData.date + 'T00:00:00').getDay()];
            
            // Show conflict details
            let detailsHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg mb-4">
                    <h4 class="font-bold text-red-800 mb-3">üìã ${isEditing ? 'Edi√ß√£o' : 'Novo Agendamento'} Solicitado:</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Cliente:</strong> ${appointmentData.client}</div>
                        <div><strong>Profissional:</strong> ${professional.name}</div>
                        <div><strong>Data:</strong> ${formattedDate} (${dayName})</div>
                        <div><strong>Hor√°rio:</strong> ${appointmentData.time}</div>
                        <div><strong>Dura√ß√£o:</strong> ${appointmentData.duration} minutos</div>
                        <div><strong>Tipo:</strong> ${getServiceTypeName(appointmentData.type)}</div>
                    </div>
                </div>
                
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h4 class="font-bold text-yellow-800 mb-3">‚ö†Ô∏è Conflitos Encontrados:</h4>
                    <div class="space-y-3">
            `;
            
            conflicts.forEach((conflict, index) => {
                const conflictEndTime = new Date(conflict.date + 'T' + conflict.time);
                conflictEndTime.setMinutes(conflictEndTime.getMinutes() + conflict.duration);
                const endTimeStr = conflictEndTime.toTimeString().substring(0, 5);
                
                detailsHTML += `
                    <div class="p-3 bg-white border border-yellow-300 rounded">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">${conflict.client}</div>
                                <div class="text-sm text-gray-600">
                                    üïí ${conflict.time} - ${endTimeStr} (${conflict.duration} min)
                                </div>
                                <div class="text-sm text-blue-600">
                                    üìã ${getServiceTypeName(conflict.type)}
                                </div>
                                ${conflict.notes ? `<div class="text-xs text-gray-500 mt-1">${conflict.notes}</div>` : ''}
                            </div>
                            <div class="ml-3">
                                <span class="inline-block w-4 h-4 rounded ${serviceColors[conflict.type] || 'bg-gray-400'}"></span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            detailsHTML += `
                    </div>
                </div>
            `;
            
            detailsDiv.innerHTML = detailsHTML;
            
            // Show resolution options
            let optionsHTML = `
                <h4 class="text-lg font-semibold mb-3 text-gray-800">üîß Op√ß√µes de Resolu√ß√£o:</h4>
                <div class="space-y-3">
            `;
            
            // Option 1: Use Smart Reschedule
            optionsHTML += `
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-blue-600 text-xl">üîÑ</span>
                        <span class="font-semibold text-blue-800">Reagendamento Inteligente</span>
                    </div>
                    <div class="text-sm text-blue-700 mb-3">
                        Use o sistema inteligente para encontrar hor√°rios alternativos ou profissionais dispon√≠veis.
                    </div>
                    <button onclick="openSmartRescheduleFromConflict()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                        üîç Buscar Alternativas
                    </button>
                </div>
            `;
            
            // Option 2: Reschedule conflicting appointment
            if (conflicts.length === 1) {
                const conflict = conflicts[0];
                optionsHTML += `
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-amber-600 text-xl">üîÑ</span>
                            <span class="font-semibold text-amber-800">Reagendar Conflito Existente</span>
                        </div>
                        <div class="text-sm text-amber-700 mb-3">
                            Reagende o agendamento conflitante "${conflict.client}" para outro hor√°rio.
                        </div>
                        <button onclick="rescheduleConflictingAppointment('${conflict.id}')" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-medium">
                            üìÖ Reagendar "${conflict.client}"
                        </button>
                    </div>
                `;
            }
            
            // Option 3: Change time/date
            optionsHTML += `
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-green-600 text-xl">‚è∞</span>
                        <span class="font-semibold text-green-800">Alterar Hor√°rio/Data</span>
                    </div>
                    <div class="text-sm text-green-700 mb-3">
                        Volte e escolha um hor√°rio ou data diferente para evitar o conflito.
                    </div>
                    <button onclick="closeConflictModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        ‚úèÔ∏è Alterar Hor√°rio/Data
                    </button>
                </div>
            `;
            
            // Option 4: Force create (only for admins or special cases)
            if (isAdminUser || professionalButtonClicks >= 2) {
                optionsHTML += `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-red-600 text-xl">‚ö†Ô∏è</span>
                            <span class="font-semibold text-red-800">For√ßar Cria√ß√£o (Admin)</span>
                        </div>
                        <div class="text-sm text-red-700 mb-3">
                            <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Criar mesmo com conflito. Ambos os agendamentos ficar√£o no mesmo hor√°rio.
                        </div>
                        <button onclick="forceCreateAppointment()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚ö†Ô∏è For√ßar Cria√ß√£o
                        </button>
                    </div>
                `;
            }
            
            optionsHTML += `</div>`;
            optionsDiv.innerHTML = optionsHTML;
            
            modal.classList.add('active');
        }

        function closeConflictModal() {
            document.getElementById('conflictModal').classList.remove('active');
            pendingAppointmentData = null;
            pendingIsEditing = false;
        }

        function openSmartRescheduleFromConflict() {
            closeConflictModal();
            
            // Create a temporary appointment to reschedule
            const tempAppointment = {
                id: 'temp_' + Date.now(),
                professionalId: pendingAppointmentData.professionalId,
                type: pendingAppointmentData.type,
                date: pendingAppointmentData.date,
                time: pendingAppointmentData.time,
                duration: pendingAppointmentData.duration,
                client: pendingAppointmentData.client,
                notes: pendingAppointmentData.notes || ''
            };
            
            // Set up reschedule modal with this appointment
            selectedAppointmentForReschedule = tempAppointment;
            
            // Open reschedule modal directly to step 2
            document.getElementById('rescheduleModal').classList.add('active');
            document.getElementById('rescheduleStep1').style.display = 'none';
            document.getElementById('rescheduleStep2').style.display = 'block';
            document.getElementById('resetRescheduleBtn').style.display = 'block';
            
            // Set the desired date and time
            document.getElementById('rescheduleNewDate').value = pendingAppointmentData.date;
            document.getElementById('rescheduleNewTime').value = pendingAppointmentData.time;
        }

        function rescheduleConflictingAppointment(conflictId) {
            const conflictAppointment = appointments.find(apt => apt.id === conflictId);
            if (!conflictAppointment) {
                alert('Agendamento conflitante n√£o encontrado.');
                return;
            }
            
            closeConflictModal();
            
            // Set up reschedule modal with the conflicting appointment
            selectedAppointmentForReschedule = conflictAppointment;
            
            // Open reschedule modal directly to step 2
            document.getElementById('rescheduleModal').classList.add('active');
            document.getElementById('rescheduleStep1').style.display = 'none';
            document.getElementById('rescheduleStep2').style.display = 'block';
            document.getElementById('resetRescheduleBtn').style.display = 'block';
            
            // Set default new date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('rescheduleNewDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('rescheduleNewTime').value = conflictAppointment.time;
        }

        function forceCreateAppointment() {
            if (!pendingAppointmentData) {
                alert('Erro: Dados do agendamento n√£o encontrados.');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a criar um agendamento com conflito de hor√°rio.\n\nIsso significa que haver√° dois ou mais agendamentos no mesmo hor√°rio para o mesmo profissional.\n\n‚ö†Ô∏è Tem certeza que deseja continuar?')) {
                return;
            }
            
            if (pendingIsEditing) {
                // Update existing appointment
                const appointmentIndex = appointments.findIndex(apt => apt.id === editingAppointmentId);
                if (appointmentIndex !== -1) {
                    appointments[appointmentIndex] = {
                        ...appointments[appointmentIndex],
                        ...pendingAppointmentData,
                        notes: (pendingAppointmentData.notes || '') + `\n[CONFLITO FOR√áADO] ${new Date().toLocaleString('pt-BR')}: Agendamento criado com conflito de hor√°rio por decis√£o administrativa.`
                    };
                    alert('‚ö†Ô∏è Agendamento atualizado com conflito for√ßado!');
                }
            } else {
                // Create new appointment
                const appointment = {
                    id: Date.now().toString(),
                    ...pendingAppointmentData,
                    notes: (pendingAppointmentData.notes || '') + `\n[CONFLITO FOR√áADO] ${new Date().toLocaleString('pt-BR')}: Agendamento criado com conflito de hor√°rio por decis√£o administrativa.`
                };
                appointments.push(appointment);
                alert('‚ö†Ô∏è Agendamento criado com conflito for√ßado!');
            }
            
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            closeConflictModal();
            closeScheduleModal();
            renderScheduleGrid();
        }

        // Login System Functions
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 3;

        function initializeDefaultAdmin() {
            // Create default admin user if no users exist
            if (users.length === 0) {
                const defaultAdmin = {
                    id: 'admin_default',
                    name: 'Administrador',
                    username: 'admin',
                    password: 'admin123', // In production, this should be hashed
                    permission: 'admin',
                    createdAt: new Date().toISOString()
                };
                users.push(defaultAdmin);
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                const user = users.find(u => u.id === currentUser.id);
                if (user) {
                    setUserPermissions(user);
                    showMainInterface();
                    return true;
                }
            }
            showLoginModal();
            return false;
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showMainInterface() {
            hideLoginModal();
            updateUserInterface();
            updateCurrentWeekDisplay();
            renderScheduleGrid();
            updateProfessionalSelect();
            renderProfessionalsList();
            checkAdminAccess();
        }

        function setUserPermissions(user) {
            isAdminUser = user.permission === 'admin';
            userPermissions.canEdit = user.permission === 'edit' || user.permission === 'admin';
            userPermissions.canView = user.permission === 'view' || user.permission === 'edit' || user.permission === 'admin';
        }

        function updateUserInterface() {
            if (!currentUser) return;

            // Show user info
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.name;
            
            const permissionLabels = {
                'view': 'üëÅÔ∏è Visualizar',
                'edit': '‚úèÔ∏è Editor',
                'admin': 'üëë Admin'
            };
            document.getElementById('currentUserPermission').textContent = permissionLabels[currentUser.permission] || currentUser.permission;

            // Show/hide buttons based on permissions
            document.getElementById('addProfessionalBtn').style.display = userPermissions.canEdit ? 'inline-block' : 'none';
            document.getElementById('newAppointmentBtn').style.display = userPermissions.canEdit ? 'inline-block' : 'none';
            document.getElementById('rescheduleBtn').style.display = userPermissions.canEdit ? 'inline-block' : 'none';
            document.getElementById('userManagementBtn').style.display = isAdminUser ? 'inline-block' : 'none';
            
            // Update admin clear button
            checkAdminAccess();
        }

        function login(username, password) {
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                setUserPermissions(user);
                showMainInterface();
                
                alert(`‚úÖ Login realizado com sucesso!\n\nBem-vindo(a), ${user.name}!\n\nN√≠vel de acesso: ${getPermissionLabel(user.permission)}`);
                return true;
            }
            
            return false;
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                currentUser = null;
                userPermissions = { canEdit: false, canView: false };
                isAdminUser = false;
                localStorage.removeItem('currentUser');
                
                // Clear any sensitive data from memory
                selectedProfessionalId = null;
                editingAppointmentId = null;
                selectedAppointmentForReschedule = null;
                
                // Close all modals
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
                
                showLoginModal();
                alert('üëã Logout realizado com sucesso!');
            }
        }

        function getPermissionLabel(permission) {
            const labels = {
                'view': 'üëÅÔ∏è Apenas Visualizar',
                'edit': '‚úèÔ∏è Visualizar e Editar',
                'admin': 'üëë Administrador Completo'
            };
            return labels[permission] || permission;
        }

        // Google Sheets Integration
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwrr0Ws2cPcZbd6ZHQDWtVL_daymH9oeFAPpN-6KlIlEVSnteAGtMM5tqSpqrJfYO2q/exec';

        async function syncUserToGoogleSheets(user, action = 'CREATE') {
            try {
                // Format data as array to match Google Sheets row format
                // [0] ‚Üí ID (coluna A)
                // [1] ‚Üí Nome Completo (coluna B) 
                // [2] ‚Üí Nome de Usu√°rio (coluna C)
                // [3] ‚Üí Senha (coluna D)
                // [4] ‚Üí N√≠vel de Acesso (coluna E)
                // [5] ‚Üí Data de Cria√ß√£o (coluna F)
                const userData = {
                    action: action,
                    data: [
                        user.id || '',                                          // [0] ID
                        user.name || '',                                        // [1] Nome Completo
                        user.username || '',                                    // [2] Nome de Usu√°rio
                        user.password || '',                                    // [3] Senha
                        user.permission || '',                                  // [4] N√≠vel de Acesso (c√≥digo)
                        user.createdAt || new Date().toISOString()              // [5] Data de Cria√ß√£o
                    ]
                };

                console.log('üì§ Enviando dados para Google Sheets:', {
                    action: action,
                    user: user.name,
                    data: userData.data
                });

                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                console.log(`‚úÖ Usu√°rio ${action === 'CREATE' ? 'criado' : action === 'UPDATE' ? 'atualizado' : 'exclu√≠do'} na planilha:`, user.name);
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao sincronizar com Google Sheets:', error);
                return false;
            }
        }

        async function syncAllUsersToGoogleSheets() {
            try {
                // Send all users to Google Sheets
                const syncPromises = users.map(user => syncUserToGoogleSheets(user, 'SYNC'));
                await Promise.all(syncPromises);
                
                alert(`‚úÖ Sincroniza√ß√£o conclu√≠da!\n\n${users.length} usu√°rio(s) foram enviados para a planilha do Google Sheets.`);
                return true;
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o completa:', error);
                alert('‚ùå Erro durante a sincroniza√ß√£o com Google Sheets.\n\nVerifique a conex√£o com a internet e tente novamente.');
                return false;
            }
        }

        // User Management Functions
        function openUserManagementModal() {
            if (!isAdminUser) {
                alert('‚ùå Acesso negado!\n\nApenas administradores podem gerenciar usu√°rios.');
                return;
            }
            document.getElementById('userManagementModal').classList.add('active');
            renderUsersList();
        }

        function closeUserManagementModal() {
            document.getElementById('userManagementModal').classList.remove('active');
            document.getElementById('addUserForm').reset();
        }

        function renderUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';

            if (users.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum usu√°rio cadastrado.</p>';
                return;
            }

            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'bg-white border rounded-lg p-4 shadow-sm';
                
                const permissionColor = {
                    'view': 'bg-blue-100 text-blue-700',
                    'edit': 'bg-green-100 text-green-700',
                    'admin': 'bg-purple-100 text-purple-700'
                };

                userDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h4 class="font-bold text-lg text-gray-800">${user.name}</h4>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${permissionColor[user.permission] || 'bg-gray-100 text-gray-700'}">
                                    ${getPermissionLabel(user.permission)}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600">
                                <span>üë§ Usu√°rio: <strong>${user.username}</strong></span>
                                ${user.createdAt ? `<span class="ml-4">üìÖ Criado: ${new Date(user.createdAt).toLocaleDateString('pt-BR')}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <button onclick="editUser('${user.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                ‚úèÔ∏è Editar
                            </button>
                            ${user.id !== 'admin_default' ? `
                                <button onclick="deleteUser('${user.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm">
                                    üóëÔ∏è Excluir
                                </button>
                            ` : `
                                <span class="text-xs text-gray-500 px-3 py-2">Admin Padr√£o</span>
                            `}
                        </div>
                    </div>
                `;
                
                container.appendChild(userDiv);
            });
        }

        function addUser(name, username, password, permission) {
            // Check if username already exists
            if (users.find(u => u.username === username)) {
                alert('‚ùå Erro!\n\nJ√° existe um usu√°rio com este nome de usu√°rio.');
                return false;
            }

            const newUser = {
                id: 'user_' + Date.now(),
                name: name,
                username: username,
                password: password, // In production, this should be hashed
                permission: permission,
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            // Sync to Google Sheets
            syncUserToGoogleSheets(newUser, 'CREATE');
            
            renderUsersList();
            document.getElementById('addUserForm').reset();
            
            alert(`‚úÖ Usu√°rio criado com sucesso!\n\nüë§ Nome: ${name}\nüîë Usu√°rio: ${username}\nüîí Senha: ${password}\nüìã Acesso: ${getPermissionLabel(permission)}\n\n‚ö†Ô∏è Anote essas informa√ß√µes, pois a senha n√£o ser√° exibida novamente!\n\nüîÑ Usu√°rio tamb√©m foi enviado para o Google Sheets.`);
            return true;
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('Usu√°rio n√£o encontrado.');
                return;
            }

            const newName = prompt('Nome completo:', user.name);
            if (newName === null) return; // Cancelled

            const newUsername = prompt('Nome de usu√°rio:', user.username);
            if (newUsername === null) return; // Cancelled

            // Check if new username conflicts with existing users
            if (newUsername !== user.username && users.find(u => u.username === newUsername)) {
                alert('‚ùå Erro!\n\nJ√° existe um usu√°rio com este nome de usu√°rio.');
                return;
            }

            const newPassword = prompt('Nova senha (deixe em branco para manter a atual):', '');
            
            const permissionOptions = ['view', 'edit', 'admin'];
            const permissionLabels = ['üëÅÔ∏è Apenas Visualizar', '‚úèÔ∏è Visualizar e Editar', 'üëë Administrador'];
            const currentPermissionIndex = permissionOptions.indexOf(user.permission);
            
            let permissionChoice = prompt(
                `N√≠vel de acesso:\n0 - ${permissionLabels[0]}\n1 - ${permissionLabels[1]}\n2 - ${permissionLabels[2]}\n\nEscolha (0-2):`, 
                currentPermissionIndex.toString()
            );
            
            if (permissionChoice === null) return; // Cancelled
            
            const permissionIndex = parseInt(permissionChoice);
            if (isNaN(permissionIndex) || permissionIndex < 0 || permissionIndex > 2) {
                alert('Op√ß√£o inv√°lida para n√≠vel de acesso.');
                return;
            }

            // Update user
            user.name = newName.trim();
            user.username = newUsername.trim();
            if (newPassword.trim() !== '') {
                user.password = newPassword.trim();
            }
            user.permission = permissionOptions[permissionIndex];

            localStorage.setItem('users', JSON.stringify(users));
            
            // Sync to Google Sheets
            syncUserToGoogleSheets(user, 'UPDATE');
            
            renderUsersList();
            
            // Update current user info if editing current user
            if (currentUser && currentUser.id === userId) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                setUserPermissions(user);
                updateUserInterface();
            }
            
            alert('‚úÖ Usu√°rio atualizado com sucesso!\n\nüîÑ Altera√ß√µes tamb√©m foram enviadas para o Google Sheets.');
        }

        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('Usu√°rio n√£o encontrado.');
                return;
            }

            if (currentUser && currentUser.id === userId) {
                alert('‚ùå Erro!\n\nVoc√™ n√£o pode excluir sua pr√≥pria conta enquanto estiver logado.');
                return;
            }

            if (confirm(`Tem certeza que deseja excluir o usu√°rio "${user.name}"?\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita.`)) {
                // Sync deletion to Google Sheets before removing from local storage
                syncUserToGoogleSheets(user, 'DELETE');
                
                users = users.filter(u => u.id !== userId);
                localStorage.setItem('users', JSON.stringify(users));
                renderUsersList();
                alert('‚úÖ Usu√°rio exclu√≠do com sucesso!\n\nüîÑ Exclus√£o tamb√©m foi enviada para o Google Sheets.');
            }
        }

        // Room Management Functions
        function renderRoomsList() {
            // Check if we should show table or cards view
            if (isTableView) {
                showRoomTableViewContent();
                return;
            }
            
            const container = document.getElementById('roomsList');
            container.innerHTML = '';

            if (roomSchedule.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üè¢</div>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">Nenhuma sala importada</h3>
                        <p class="text-gray-500 mb-4">Importe a planilha "Separa√ß√£o de Salas.xlsx" para visualizar a ocupa√ß√£o das salas.</p>
                        <button onclick="exportToExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg font-medium">
                            üè¢ Importar Separa√ß√£o de Salas
                        </button>
                    </div>
                `;
                updateRoomsResultsCounter(0, 0);
                return;
            }

            // Group by room for compact display
            const roomGroups = {};
            roomSchedule.forEach(slot => {
                if (!roomGroups[slot.roomName]) {
                    roomGroups[slot.roomName] = [];
                }
                roomGroups[slot.roomName].push(slot);
            });

            if (Object.keys(roomGroups).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 bg-white rounded-lg shadow-sm">
                        <div class="text-4xl mb-3">üîç</div>
                        <h3 class="text-lg font-bold text-gray-600 mb-2">Nenhum resultado encontrado</h3>
                        <p class="text-gray-500">Tente importar a planilha de salas novamente</p>
                    </div>
                `;
                updateRoomsResultsCounter(0, Object.keys(roomGroups).length);
                return;
            }

            // Create compact room cards
            let roomsHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">`;

            Object.keys(roomGroups).sort().forEach(roomName => {
                const roomSlots = roomGroups[roomName];
                const occupiedSlots = roomSlots.filter(s => s.isOccupied);
                const freeSlots = roomSlots.filter(s => !s.isOccupied);
                const conflictSlots = roomSlots.filter(s => s.hasScheduleConflict);
                const linkedSlots = roomSlots.filter(s => s.linkedAppointmentId);
                const errorSlots = roomSlots.filter(s => s.hasValidationError);
                
                const occupancyRate = roomSlots.length > 0 ? (occupiedSlots.length / roomSlots.length) * 100 : 0;
                
                // Determine room status color
                let statusColor = 'bg-green-500';
                let statusText = 'Dispon√≠vel';
                if (occupancyRate > 80) {
                    statusColor = 'bg-red-500';
                    statusText = 'Muito Ocupada';
                } else if (occupancyRate > 50) {
                    statusColor = 'bg-orange-500';
                    statusText = 'Ocupada';
                } else if (occupancyRate > 20) {
                    statusColor = 'bg-yellow-500';
                    statusText = 'Parcialmente Ocupada';
                }

                roomsHTML += `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-200 overflow-hidden">
                        <!-- Room Header -->
                        <div class="bg-gradient-to-r from-teal-500 to-blue-600 text-white p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-lg truncate">${roomName}</h3>
                                <div class="flex items-center gap-1">
                                    <div class="w-3 h-3 rounded-full ${statusColor}"></div>
                                </div>
                            </div>
                            <div class="text-xs text-blue-100">${statusText} ‚Ä¢ ${Math.round(occupancyRate)}% ocupa√ß√£o</div>
                        </div>
                        
                        <!-- Stats Row -->
                        <div class="p-3 bg-gray-50 border-b">
                            <div class="grid grid-cols-4 gap-2 text-center">
                                <div class="bg-white rounded-lg p-2 shadow-sm">
                                    <div class="text-lg font-bold text-gray-800">${roomSlots.length}</div>
                                    <div class="text-xs text-gray-500">Total</div>
                                </div>
                                <div class="bg-red-50 rounded-lg p-2 shadow-sm">
                                    <div class="text-lg font-bold text-red-600">${occupiedSlots.length}</div>
                                    <div class="text-xs text-red-500">Ocupadas</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-2 shadow-sm">
                                    <div class="text-lg font-bold text-green-600">${freeSlots.length}</div>
                                    <div class="text-xs text-green-500">Livres</div>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-2 shadow-sm">
                                    <div class="text-lg font-bold text-blue-600">${linkedSlots.length}</div>
                                    <div class="text-xs text-blue-500">Vinculadas</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alerts Row -->
                        ${(conflictSlots.length > 0 || errorSlots.length > 0) ? `
                            <div class="p-3 bg-yellow-50 border-b">
                                <div class="flex items-center justify-center gap-4 text-xs">
                                    ${conflictSlots.length > 0 ? `
                                        <div class="flex items-center gap-1 text-orange-600">
                                            <span>‚ö†Ô∏è</span>
                                            <span>${conflictSlots.length} conflito(s)</span>
                                        </div>
                                    ` : ''}
                                    ${errorSlots.length > 0 ? `
                                        <div class="flex items-center gap-1 text-red-600">
                                            <span>‚ùå</span>
                                            <span>${errorSlots.length} erro(s)</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Occupancy Preview -->
                        <div class="p-3">
                            <div class="text-xs font-semibold text-gray-600 mb-2">üìÖ Ocupa√ß√£o por Dia:</div>
                            <div class="space-y-1">
                `;
                
                // Group by day
                const dayGroups = {};
                roomSlots.forEach(slot => {
                    if (!dayGroups[slot.dayOfWeek]) {
                        dayGroups[slot.dayOfWeek] = { occupied: 0, total: 0 };
                    }
                    dayGroups[slot.dayOfWeek].total++;
                    if (slot.isOccupied) {
                        dayGroups[slot.dayOfWeek].occupied++;
                    }
                });
                
                const dayOrder = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
                dayOrder.forEach(day => {
                    if (dayGroups[day]) {
                        const dayData = dayGroups[day];
                        const dayRate = (dayData.occupied / dayData.total) * 100;
                        let dayColor = 'bg-green-200';
                        if (dayRate > 80) dayColor = 'bg-red-200';
                        else if (dayRate > 50) dayColor = 'bg-orange-200';
                        else if (dayRate > 20) dayColor = 'bg-yellow-200';
                        
                        roomsHTML += `
                            <div class="flex items-center justify-between text-xs">
                                <span class="font-medium text-gray-600">${day.substring(0, 3)}</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="${dayColor} h-full rounded-full" style="width: ${dayRate}%"></div>
                                    </div>
                                    <span class="text-gray-500 w-8 text-right">${dayData.occupied}/${dayData.total}</span>
                                </div>
                            </div>
                        `;
                    }
                });
                
                roomsHTML += `
                            </div>
                        </div>
                        
                        <!-- Action Button -->
                        <div class="p-3 bg-gray-50">
                            <button onclick="viewRoomDetails('${roomName}')" class="w-full bg-teal-500 hover:bg-teal-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                üìã Ver Detalhes
                            </button>
                        </div>
                    </div>
                `;
            });

            roomsHTML += `</div>`;

            // Add summary stats at the top
            const totalRooms = Object.keys(roomGroups).length;
            const totalSlots = roomSchedule.length;
            const totalOccupied = roomSchedule.filter(s => s.isOccupied).length;
            const totalConflicts = roomSchedule.filter(s => s.hasScheduleConflict).length;
            const totalLinked = roomSchedule.filter(s => s.linkedAppointmentId).length;
            const totalErrors = roomSchedule.filter(s => s.hasValidationError).length;

            const summaryHTML = `
                <div class="mb-6 bg-gradient-to-r from-teal-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                    <h3 class="text-2xl font-bold mb-4">üìä Resumo Geral das Salas</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold">${totalRooms}</div>
                            <div class="text-sm text-blue-100">Salas</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold">${totalSlots}</div>
                            <div class="text-sm text-blue-100">Hor√°rios</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold">${totalOccupied}</div>
                            <div class="text-sm text-blue-100">Ocupados</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold">${totalLinked}</div>
                            <div class="text-sm text-blue-100">Vinculados</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold">${totalConflicts}</div>
                            <div class="text-sm text-blue-100">Conflitos</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold">${totalErrors}</div>
                            <div class="text-sm text-blue-100">Erros</div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = summaryHTML + roomsHTML;
            
            // Update results counter
            const totalRoomsAll = [...new Set(roomSchedule.map(s => s.roomName))].length;
            updateRoomsResultsCounter(totalRooms, totalRoomsAll);
        }

        function viewRoomDetails(roomName) {
            const roomSlots = roomSchedule.filter(slot => slot.roomName === roomName);
            
            if (roomSlots.length === 0) {
                alert(`‚ùå Nenhum dado encontrado para a sala "${roomName}".`);
                return;
            }
            
            // Group by day and show detailed schedule
            const dayGroups = {};
            roomSlots.forEach(slot => {
                if (!dayGroups[slot.dayOfWeek]) {
                    dayGroups[slot.dayOfWeek] = [];
                }
                dayGroups[slot.dayOfWeek].push(slot);
            });
            
            let detailsText = `üè¢ DETALHES DA SALA: ${roomName}\n\n`;
            
            Object.keys(dayGroups).sort().forEach(dayName => {
                const daySlots = dayGroups[dayName].sort((a, b) => a.time.localeCompare(b.time));
                const occupied = daySlots.filter(s => s.isOccupied);
                const free = daySlots.filter(s => !s.isOccupied);
                
                detailsText += `üìÖ ${dayName.toUpperCase()}\n`;
                detailsText += `   Total: ${daySlots.length} | Ocupados: ${occupied.length} | Livres: ${free.length}\n`;
                
                if (occupied.length > 0) {
                    detailsText += `   üî¥ Ocupados: `;
                    detailsText += occupied.map(s => `${s.time}${s.patientName ? '(' + s.patientName + ')' : ''}`).join(', ');
                    detailsText += `\n`;
                }
                
                if (free.length > 0) {
                    detailsText += `   üü¢ Livres: `;
                    detailsText += free.map(s => s.time).join(', ');
                    detailsText += `\n`;
                }
                
                detailsText += `\n`;
            });
            
            alert(detailsText);
        }

        // Room Filter Functions
        function initializeRoomFilters() {
            // Populate room filter dropdown (multiple select)
            const roomFilter = document.getElementById('roomFilter');
            const uniqueRooms = [...new Set(roomSchedule.map(slot => slot.roomName))].sort();
            roomFilter.innerHTML = '';
            uniqueRooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                roomFilter.appendChild(option);
            });

            // Populate time filter dropdown (multiple select)
            const timeFilter = document.getElementById('timeFilter');
            const uniqueTimes = [...new Set(roomSchedule.map(slot => slot.time))].sort();
            timeFilter.innerHTML = '';
            uniqueTimes.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeFilter.appendChild(option);
            });

            // Populate professional filter dropdown (multiple select)
            const professionalFilter = document.getElementById('professionalRoomFilter');
            const uniqueProfessionals = [...new Set(roomSchedule
                .filter(slot => slot.professionalName && slot.professionalName.trim() !== '')
                .map(slot => slot.professionalName))].sort();
            professionalFilter.innerHTML = '';
            uniqueProfessionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                professionalFilter.appendChild(option);
            });
        }

        function applyAllRoomFilters(schedule) {
            let filtered = [...schedule];

            // Room filter (checkbox selection)
            const selectedRooms = Array.from(document.querySelectorAll('.room-filter-option:checked')).map(cb => cb.value);
            if (selectedRooms.length > 0) {
                filtered = filtered.filter(slot => selectedRooms.includes(slot.roomName));
            }

            // Day filter (checkbox selection)
            const selectedDays = Array.from(document.querySelectorAll('.day-filter-option:checked')).map(cb => cb.value);
            if (selectedDays.length > 0) {
                filtered = filtered.filter(slot => selectedDays.includes(slot.dayOfWeek));
            }

            // Time filter (checkbox selection)
            const selectedTimes = Array.from(document.querySelectorAll('.time-filter-option:checked')).map(cb => cb.value);
            if (selectedTimes.length > 0) {
                filtered = filtered.filter(slot => selectedTimes.includes(slot.time));
            }

            // Professional filter (checkbox selection)
            const selectedProfessionals = Array.from(document.querySelectorAll('.professional-filter-option:checked')).map(cb => cb.value);
            if (selectedProfessionals.length > 0) {
                filtered = filtered.filter(slot => selectedProfessionals.includes(slot.professionalName));
            }

            // Status filter (single selection)
            const statusFilter = document.getElementById('statusFilter')?.value;
            if (statusFilter) {
                switch (statusFilter) {
                    case 'occupied':
                        filtered = filtered.filter(slot => slot.isOccupied);
                        break;
                    case 'free':
                        filtered = filtered.filter(slot => !slot.isOccupied);
                        break;
                    case 'linked':
                        filtered = filtered.filter(slot => slot.linkedAppointmentId);
                        break;
                    case 'conflict':
                        filtered = filtered.filter(slot => slot.hasScheduleConflict);
                        break;
                    case 'error':
                        filtered = filtered.filter(slot => slot.hasValidationError);
                        break;
                }
            }

            // Patient filter (text search)
            const patientFilter = document.getElementById('patientFilter')?.value.toLowerCase().trim();
            if (patientFilter) {
                filtered = filtered.filter(slot => 
                    slot.patientName.toLowerCase().includes(patientFilter)
                );
            }

            // Integration filter (single selection)
            const integrationFilter = document.getElementById('integrationFilter')?.value;
            if (integrationFilter) {
                switch (integrationFilter) {
                    case 'linked':
                        filtered = filtered.filter(slot => slot.linkedAppointmentId);
                        break;
                    case 'conflict':
                        filtered = filtered.filter(slot => slot.hasScheduleConflict);
                        break;
                    case 'new':
                        filtered = filtered.filter(slot => slot.isOccupied && !slot.linkedAppointmentId && !slot.hasScheduleConflict);
                        break;
                    case 'na':
                        filtered = filtered.filter(slot => !slot.isOccupied);
                        break;
                }
            }

            // Validation filter (single selection)
            const validationFilter = document.getElementById('validationFilter')?.value;
            if (validationFilter) {
                switch (validationFilter) {
                    case 'ok':
                        filtered = filtered.filter(slot => !slot.hasValidationError && !slot.wasAutoCorrected);
                        break;
                    case 'corrected':
                        filtered = filtered.filter(slot => slot.wasAutoCorrected);
                        break;
                    case 'error':
                        filtered = filtered.filter(slot => slot.hasValidationError);
                        break;
                }
            }

            return filtered;
        }

        function applyRoomFilters() {
            updateActiveFiltersDisplay();
            renderRoomsList();
        }

        function updateActiveFiltersDisplay() {
            const activeFilters = [];
            
            // Check room filter (multiple selection)
            const roomFilter = document.getElementById('roomFilter');
            const selectedRooms = Array.from(roomFilter?.selectedOptions || []).map(option => option.value);
            if (selectedRooms.length > 0) {
                if (selectedRooms.length === 1) {
                    activeFilters.push(`üè¢ Sala: ${selectedRooms[0]}`);
                } else {
                    activeFilters.push(`üè¢ Salas: ${selectedRooms.length} selecionadas`);
                }
            }
            
            // Check day filter (multiple selection)
            const dayFilter = document.getElementById('dayFilter');
            const selectedDays = Array.from(dayFilter?.selectedOptions || []).map(option => option.value);
            if (selectedDays.length > 0) {
                if (selectedDays.length === 1) {
                    activeFilters.push(`üìÖ Dia: ${selectedDays[0]}`);
                } else {
                    activeFilters.push(`üìÖ Dias: ${selectedDays.length} selecionados`);
                }
            }
            
            // Check time filter (multiple selection)
            const timeFilter = document.getElementById('timeFilter');
            const selectedTimes = Array.from(timeFilter?.selectedOptions || []).map(option => option.value);
            if (selectedTimes.length > 0) {
                if (selectedTimes.length === 1) {
                    activeFilters.push(`‚è∞ Hor√°rio: ${selectedTimes[0]}`);
                } else {
                    activeFilters.push(`‚è∞ Hor√°rios: ${selectedTimes.length} selecionados`);
                }
            }
            
            // Check professional filter (multiple selection)
            const professionalFilter = document.getElementById('professionalRoomFilter');
            const selectedProfessionals = Array.from(professionalFilter?.selectedOptions || []).map(option => option.value);
            if (selectedProfessionals.length > 0) {
                if (selectedProfessionals.length === 1) {
                    activeFilters.push(`üë®‚Äç‚öïÔ∏è Profissional: ${selectedProfessionals[0]}`);
                } else {
                    activeFilters.push(`üë®‚Äç‚öïÔ∏è Profissionais: ${selectedProfessionals.length} selecionados`);
                }
            }
            
            // Check single selection filters
            const statusFilter = document.getElementById('statusFilter')?.value;
            if (statusFilter) {
                const statusLabels = {
                    'occupied': 'üî¥ Ocupadas',
                    'free': 'üü¢ Livres',
                    'linked': 'üîó Vinculadas',
                    'conflict': '‚ö†Ô∏è Conflitos',
                    'error': '‚ùå Com Erro'
                };
                activeFilters.push(`üìä Status: ${statusLabels[statusFilter] || statusFilter}`);
            }
            
            const patientFilter = document.getElementById('patientFilter')?.value;
            if (patientFilter) activeFilters.push(`üë§ Paciente: ${patientFilter}`);
            
            const integrationFilter = document.getElementById('integrationFilter')?.value;
            if (integrationFilter) {
                const integrationLabels = {
                    'linked': 'üîó Vinculado',
                    'conflict': '‚ö†Ô∏è Conflito',
                    'new': 'üÜï Novo',
                    'na': '‚ûñ N/A'
                };
                activeFilters.push(`üîó Integra√ß√£o: ${integrationLabels[integrationFilter] || integrationFilter}`);
            }
            
            const validationFilter = document.getElementById('validationFilter')?.value;
            if (validationFilter) {
                const validationLabels = {
                    'ok': '‚úÖ OK',
                    'corrected': 'üîÑ Corrigido',
                    'error': '‚ùå Erro'
                };
                activeFilters.push(`‚úÖ Valida√ß√£o: ${validationLabels[validationFilter] || validationFilter}`);
            }
            
            // Update display
            const display = document.getElementById('activeFiltersDisplay');
            const list = document.getElementById('activeFiltersList');
            
            if (activeFilters.length > 0) {
                display.style.display = 'block';
                list.innerHTML = activeFilters.map(filter => 
                    `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs">${filter}</span>`
                ).join('');
            } else {
                display.style.display = 'none';
            }
        }

        function clearAllRoomFilters() {
            // Clear checkbox filters
            document.querySelectorAll('.room-filter-option').forEach(cb => cb.checked = false);
            document.querySelectorAll('.day-filter-option').forEach(cb => cb.checked = false);
            document.querySelectorAll('.time-filter-option').forEach(cb => cb.checked = false);
            document.querySelectorAll('.professional-filter-option').forEach(cb => cb.checked = false);
            
            // Clear select all checkboxes
            const selectAllRooms = document.getElementById('selectAllRooms');
            if (selectAllRooms) selectAllRooms.checked = false;
            
            const selectAllDays = document.getElementById('selectAllDays');
            if (selectAllDays) selectAllDays.checked = false;
            
            const selectAllTimes = document.getElementById('selectAllTimes');
            if (selectAllTimes) selectAllTimes.checked = false;
            
            const selectAllProfessionals = document.getElementById('selectAllProfessionals');
            if (selectAllProfessionals) selectAllProfessionals.checked = false;
            
            // Clear single selection filters
            document.getElementById('statusFilter').value = '';
            document.getElementById('patientFilter').value = '';
            document.getElementById('integrationFilter').value = '';
            document.getElementById('validationFilter').value = '';
            
            // Update display texts
            document.getElementById('roomFilterDisplay').textContent = 'Todas as salas';
            document.getElementById('dayFilterDisplay').textContent = 'Todos os dias';
            document.getElementById('timeFilterDisplay').textContent = 'Todos os hor√°rios';
            document.getElementById('professionalFilterDisplay').textContent = 'Todos os profissionais';
            
            // Close all dropdowns
            openDropdowns.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            openDropdowns.clear();
            
            updateActiveFiltersDisplay();
            
            if (isTableView) {
                showRoomTableView();
            } else {
                renderRoomsList();
            }
        }

        function setQuickFilter(filterType) {
            // Clear all filters first
            clearAllRoomFilters();
            
            // Apply specific quick filter
            switch (filterType) {
                case 'available':
                    document.getElementById('statusFilter').value = 'free';
                    break;
                case 'occupied':
                    document.getElementById('statusFilter').value = 'occupied';
                    break;
                case 'conflicts':
                    document.getElementById('statusFilter').value = 'conflict';
                    break;
                case 'linked':
                    document.getElementById('statusFilter').value = 'linked';
                    break;
                case 'today':
                    const today = new Date();
                    const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
                    const todayName = dayNames[today.getDay()];
                    // Map to our day format
                    const dayMapping = {
                        'Domingo': 'Domingo',
                        'Segunda': 'Segunda',
                        'Ter√ßa': 'Ter√ßa',
                        'Quarta': 'Quarta',
                        'Quinta': 'Quinta',
                        'Sexta': 'Sexta',
                        'S√°bado': 'S√°bado'
                    };
                    if (dayMapping[todayName]) {
                        const dayFilter = document.getElementById('dayFilter');
                        Array.from(dayFilter.options).forEach(option => {
                            option.selected = option.value === dayMapping[todayName];
                        });
                    }
                    break;
            }
            
            updateActiveFiltersDisplay();
            renderRoomsList();
        }

        function updateRoomsResultsCounter(filtered, total) {
            const counter = document.getElementById('roomsResultsCounter');
            const text = document.getElementById('roomsResultsText');
            
            if (filtered === total) {
                counter.style.display = 'none';
            } else {
                counter.style.display = 'block';
                text.textContent = `Mostrando ${filtered} de ${total} salas`;
            }
        }

        // Room view mode toggle
        let isTableView = true; // Start with table view

        function showRoomTableViewContent() {
            isTableView = true;
            updateViewButtons();
            showRoomTableViewContent();
        }

        function showRoomCardsView() {
            isTableView = false;
            updateViewButtons();
            renderRoomsList();
        }

        function updateViewButtons() {
            const tableBtn = document.getElementById('tableViewBtn');
            const cardsBtn = document.getElementById('cardsViewBtn');
            
            if (isTableView) {
                tableBtn.className = 'bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2';
                cardsBtn.className = 'bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2';
            } else {
                tableBtn.className = 'bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2';
                cardsBtn.className = 'bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2';
            }
        }

        function showRoomTableViewContent() {
            const container = document.getElementById('roomsList');
            
            if (roomSchedule.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üè¢</div>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">Nenhuma sala importada</h3>
                        <p class="text-gray-500 mb-4">Importe a planilha "Separa√ß√£o de Salas.xlsx" para visualizar a ocupa√ß√£o das salas.</p>
                        <button onclick="exportToExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg font-medium">
                            üè¢ Importar Separa√ß√£o de Salas
                        </button>
                    </div>
                `;
                return;
            }

            // Use all room schedule data
            let filteredSchedule = roomSchedule;

            if (filteredSchedule.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 bg-white rounded-lg shadow-sm">
                        <div class="text-4xl mb-3">üîç</div>
                        <h3 class="text-lg font-bold text-gray-600 mb-2">Nenhum resultado encontrado</h3>
                        <p class="text-gray-500">Tente importar a planilha de salas novamente</p>
                    </div>
                `;
                return;
            }

            // Create table view
            let tableHTML = `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gradient-to-r from-teal-500 to-blue-600 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left font-bold">üè¢ Sala</th>
                                    <th class="px-4 py-3 text-left font-bold">üìÖ Dia</th>
                                    <th class="px-4 py-3 text-left font-bold">‚è∞ Hor√°rio</th>
                                    <th class="px-4 py-3 text-left font-bold">üìä Status</th>
                                    <th class="px-4 py-3 text-left font-bold">üë§ Paciente</th>
                                    <th class="px-4 py-3 text-left font-bold">üë®‚Äç‚öïÔ∏è Profissional</th>
                                    <th class="px-4 py-3 text-left font-bold">üîó Integra√ß√£o</th>
                                    <th class="px-4 py-3 text-left font-bold">‚úÖ Valida√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
            `;

            // Sort filtered schedule
            filteredSchedule.sort((a, b) => {
                if (a.roomName !== b.roomName) return a.roomName.localeCompare(b.roomName);
                if (a.dayOfWeek !== b.dayOfWeek) return a.dayOfWeek.localeCompare(b.dayOfWeek);
                return a.time.localeCompare(b.time);
            });

            filteredSchedule.forEach((slot, index) => {
                const isEven = index % 2 === 0;
                const rowClass = isEven ? 'bg-white' : 'bg-gray-50';
                
                let statusBadge = '';
                let integrationBadge = '';
                let validationBadge = '';
                
                // Status badge
                if (slot.isOccupied) {
                    statusBadge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-medium">üî¥ Ocupada</span>';
                } else {
                    statusBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-medium">üü¢ Livre</span>';
                }
                
                // Integration badge
                if (slot.linkedAppointmentId) {
                    integrationBadge = '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-medium">üîó Vinculado</span>';
                } else if (slot.hasScheduleConflict) {
                    integrationBadge = '<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-xs font-medium">‚ö†Ô∏è Conflito</span>';
                } else if (slot.isOccupied) {
                    integrationBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-medium">üÜï Novo</span>';
                } else {
                    integrationBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs font-medium">‚ûñ N/A</span>';
                }
                
                // Validation badge
                if (slot.hasValidationError) {
                    validationBadge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-medium">‚ùå Erro</span>';
                } else if (slot.wasAutoCorrected) {
                    validationBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-medium">üîÑ Corrigido</span>';
                } else {
                    validationBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-medium">‚úÖ OK</span>';
                }
                
                tableHTML += `
                    <tr class="${rowClass} hover:bg-blue-50 transition-colors">
                        <td class="px-4 py-3 font-medium text-gray-900">${slot.roomName}</td>
                        <td class="px-4 py-3 text-gray-700">${slot.dayOfWeek}</td>
                        <td class="px-4 py-3 text-gray-700 font-mono">${slot.time}</td>
                        <td class="px-4 py-3">${statusBadge}</td>
                        <td class="px-4 py-3 text-gray-700">${slot.patientName || '-'}</td>
                        <td class="px-4 py-3 text-gray-700">${slot.professionalName || '-'}</td>
                        <td class="px-4 py-3">${integrationBadge}</td>
                        <td class="px-4 py-3">${validationBadge}</td>
                    </tr>
                `;
            });

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            container.innerHTML = tableHTML;
            
            // Update results counter
            const totalRooms = [...new Set(roomSchedule.map(s => s.roomName))].length;
            const filteredRooms = [...new Set(filteredSchedule.map(s => s.roomName))].length;
            updateRoomsResultsCounter(filteredRooms, totalRooms);
        }

        // Visual dropdown functions
        let openDropdowns = new Set();

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const isOpen = dropdown.style.display !== 'none';
            
            // Close all other dropdowns
            openDropdowns.forEach(id => {
                if (id !== dropdownId) {
                    document.getElementById(id).style.display = 'none';
                }
            });
            openDropdowns.clear();
            
            if (isOpen) {
                dropdown.style.display = 'none';
            } else {
                dropdown.style.display = 'block';
                openDropdowns.add(dropdownId);
                
                // Initialize dropdown content if needed
                if (dropdownId === 'roomFilterDropdown') {
                    initializeRoomFilterDropdown();
                } else if (dropdownId === 'timeFilterDropdown') {
                    initializeTimeFilterDropdown();
                } else if (dropdownId === 'professionalFilterDropdown') {
                    initializeProfessionalFilterDropdown();
                }
            }
        }

        function initializeRoomFilterDropdown() {
            const container = document.getElementById('roomFilterOptions');
            const uniqueRooms = [...new Set(roomSchedule.map(slot => slot.roomName))].sort();
            
            container.innerHTML = '';
            uniqueRooms.forEach(room => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${room}" onchange="updateRoomFilter()" class="w-4 h-4 text-teal-600 room-filter-option">
                    <span class="text-sm">${room}</span>
                `;
                container.appendChild(label);
            });
        }

        function initializeTimeFilterDropdown() {
            const container = document.getElementById('timeFilterOptions');
            const uniqueTimes = [...new Set(roomSchedule.map(slot => slot.time))].sort();
            
            container.innerHTML = '';
            uniqueTimes.forEach(time => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${time}" onchange="updateTimeFilter()" class="w-4 h-4 text-teal-600 time-filter-option">
                    <span class="text-sm font-mono">${time}</span>
                `;
                container.appendChild(label);
            });
        }

        function initializeProfessionalFilterDropdown() {
            const container = document.getElementById('professionalFilterOptions');
            const uniqueProfessionals = [...new Set(roomSchedule
                .filter(slot => slot.professionalName && slot.professionalName.trim() !== '')
                .map(slot => slot.professionalName))].sort();
            
            container.innerHTML = '';
            uniqueProfessionals.forEach(prof => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${prof}" onchange="updateProfessionalFilter()" class="w-4 h-4 text-teal-600 professional-filter-option">
                    <span class="text-sm">${prof}</span>
                `;
                container.appendChild(label);
            });
        }

        // Filter update functions
        function updateRoomFilter() {
            const selectedRooms = Array.from(document.querySelectorAll('.room-filter-option:checked')).map(cb => cb.value);
            const display = document.getElementById('roomFilterDisplay');
            
            if (selectedRooms.length === 0) {
                display.textContent = 'Todas as salas';
            } else if (selectedRooms.length === 1) {
                display.textContent = selectedRooms[0];
            } else {
                display.textContent = `${selectedRooms.length} salas selecionadas`;
            }
            
            applyRoomFilters();
        }

        function updateDayFilter() {
            const selectedDays = Array.from(document.querySelectorAll('.day-filter-option:checked')).map(cb => cb.value);
            const display = document.getElementById('dayFilterDisplay');
            
            if (selectedDays.length === 0) {
                display.textContent = 'Todos os dias';
            } else if (selectedDays.length === 1) {
                display.textContent = selectedDays[0] + '-feira';
            } else {
                display.textContent = `${selectedDays.length} dias selecionados`;
            }
            
            applyRoomFilters();
        }

        function updateTimeFilter() {
            const selectedTimes = Array.from(document.querySelectorAll('.time-filter-option:checked')).map(cb => cb.value);
            const display = document.getElementById('timeFilterDisplay');
            
            if (selectedTimes.length === 0) {
                display.textContent = 'Todos os hor√°rios';
            } else if (selectedTimes.length === 1) {
                display.textContent = selectedTimes[0];
            } else {
                display.textContent = `${selectedTimes.length} hor√°rios selecionados`;
            }
            
            applyRoomFilters();
        }

        function updateProfessionalFilter() {
            const selectedProfessionals = Array.from(document.querySelectorAll('.professional-filter-option:checked')).map(cb => cb.value);
            const display = document.getElementById('professionalFilterDisplay');
            
            if (selectedProfessionals.length === 0) {
                display.textContent = 'Todos os profissionais';
            } else if (selectedProfessionals.length === 1) {
                display.textContent = selectedProfessionals[0];
            } else {
                display.textContent = `${selectedProfessionals.length} profissionais selecionados`;
            }
            
            applyRoomFilters();
        }

        // Select all functions
        function toggleSelectAllRooms() {
            const selectAll = document.getElementById('selectAllRooms');
            const options = document.querySelectorAll('.room-filter-option');
            
            options.forEach(option => {
                option.checked = selectAll.checked;
            });
            
            updateRoomFilter();
        }

        function toggleSelectAllDays() {
            const selectAll = document.getElementById('selectAllDays');
            const options = document.querySelectorAll('.day-filter-option');
            
            options.forEach(option => {
                option.checked = selectAll.checked;
            });
            
            updateDayFilter();
        }

        function toggleSelectAllTimes() {
            const selectAll = document.getElementById('selectAllTimes');
            const options = document.querySelectorAll('.time-filter-option');
            
            options.forEach(option => {
                option.checked = selectAll.checked;
            });
            
            updateTimeFilter();
        }

        function toggleSelectAllProfessionals() {
            const selectAll = document.getElementById('selectAllProfessionals');
            const options = document.querySelectorAll('.professional-filter-option');
            
            options.forEach(option => {
                option.checked = selectAll.checked;
            });
            
            updateProfessionalFilter();
        }

        // Initialize the application
        function init() {
            initializeDefaultAdmin();
            if (!checkLoginStatus()) {
                return; // User needs to login first
            }
        }

        // Admin access control
        let professionalButtonClicks = 0;
        let lastClickTime = 0;
        const CLICK_TIMEOUT = 3000; // 3 seconds timeout between clicks

        // Check admin access and show/hide admin button
        function checkAdminAccess() {
            const adminBtn = document.getElementById('adminClearBtn');
            
            if (isAdminUser || professionalButtonClicks >= 2) {
                adminBtn.style.display = 'flex';
            } else {
                adminBtn.style.display = 'none';
            }
        }

        // Handle professional button clicks for admin access
        function handleProfessionalButtonClick() {
            const currentTime = Date.now();
            
            // Reset counter if too much time has passed since last click
            if (currentTime - lastClickTime > CLICK_TIMEOUT) {
                professionalButtonClicks = 0;
            }
            
            professionalButtonClicks++;
            lastClickTime = currentTime;
            
            // Show progress feedback
            if (professionalButtonClicks === 1) {
                console.log('üîê Sequ√™ncia de acesso admin iniciada... (1/2)');
            } else if (professionalButtonClicks === 2) {
                console.log('üîê Acesso admin ativado!');
                alert('üîì Modo Administrador Ativado!\n\nO bot√£o de limpeza geral agora est√° dispon√≠vel no cabe√ßalho.\n\n‚ö†Ô∏è Use com extrema cautela!');
                checkAdminAccess();
            }
            
            // Reset after 3 clicks to prevent accumulation
            if (professionalButtonClicks > 3) {
                professionalButtonClicks = 0;
            }
        }

        // Admin functions
        function showAdminClearModal() {
            if (!isAdminUser && professionalButtonClicks < 2) {
                alert('Acesso negado. Apenas administradores podem usar esta fun√ß√£o.');
                return;
            }
            
            // Direct confirmation dialog
            confirmAdminClear();
        }

        function closeAdminClearModal() {
            // Function kept for compatibility but not needed anymore
        }

        function confirmAdminClear() {
            // Direct confirmation with Yes/No
            if (!confirm('üö® ATEN√á√ÉO - FORMATA√á√ÉO COMPLETA DO SISTEMA\n\n‚ö†Ô∏è Esta a√ß√£o ir√° apagar PERMANENTEMENTE:\n‚Ä¢ Todos os profissionais cadastrados\n‚Ä¢ Todos os agendamentos\n‚Ä¢ Todos os dados do sistema\n\n‚ùå ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!\n\nüóëÔ∏è Deseja realmente apagar TUDO?')) {
                closeAdminClearModal();
                return;
            }
            
            try {
                // FORMATA√á√ÉO COMPLETA DO SISTEMA
                console.log('üî• INICIANDO FORMATA√á√ÉO COMPLETA DO SISTEMA...');
                
                // 1. Limpar todas as vari√°veis globais
                professionals = [];
                appointments = [];
                selectedProfessionalId = null;
                editingAppointmentId = null;
                tempImportData = null;
                selectedAppointmentForReschedule = null;
                
                // 2. Limpar COMPLETAMENTE o localStorage
                localStorage.clear(); // Remove TUDO do localStorage
                
                // 3. Limpar tamb√©m chaves espec√≠ficas (garantia dupla)
                localStorage.removeItem('professionals');
                localStorage.removeItem('appointments');
                
                // 4. Resetar todas as vari√°veis de controle
                currentWeekStart = new Date();
                const today = new Date();
                const dayOfWeek = today.getDay();
                const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                currentWeekStart.setDate(today.getDate() + daysToMonday);
                currentWeekStart.setHours(0, 0, 0, 0);
                
                // 5. Limpar todos os formul√°rios
                document.getElementById('professionalForm').reset();
                document.getElementById('scheduleForm').reset();
                document.getElementById('professionalSearch').value = '';
                document.getElementById('excelFile').value = '';
                
                // 6. Fechar todos os modais
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
                
                // 7. Limpar dropdowns e elementos din√¢micos
                document.getElementById('professionalDropdown').innerHTML = '';
                document.getElementById('professionalDropdown').style.display = 'none';
                document.getElementById('selectedProfessionalInfo').style.display = 'none';
                
                // 8. Atualizar TODA a interface
                updateCurrentWeekDisplay();
                updateProfessionalSelect();
                renderProfessionalsList();
                renderScheduleGrid();
                clearProfessionalFilter();
                
                // 9. Voltar para a vis√£o semanal
                showWeeklyView();
                
                // 10. Reset completo do controle de admin
                professionalButtonClicks = 0;
                lastClickTime = 0;
                isAdminUser = false;
                checkAdminAccess(); // Esconde o bot√£o admin
                
                // 12. For√ßar atualiza√ß√£o da p√°gina (garantia final)
                setTimeout(() => {
                    // Verifica√ß√£o final - se ainda houver dados, for√ßa reload
                    const remainingProfs = JSON.parse(localStorage.getItem('professionals') || '[]');
                    const remainingApts = JSON.parse(localStorage.getItem('appointments') || '[]');
                    
                    if (remainingProfs.length > 0 || remainingApts.length > 0) {
                        console.log('‚ö†Ô∏è Dados residuais detectados, for√ßando reload...');
                        location.reload();
                    }
                }, 100);
                
                // Success message detalhada
                alert('üî• FORMATA√á√ÉO COMPLETA REALIZADA!\n\n‚úÖ REMOVIDO COM SUCESSO:\n‚Ä¢ Todos os profissionais (cadastrados + importados)\n‚Ä¢ Todos os agendamentos (manuais + importados)\n‚Ä¢ Todo o hist√≥rico de dados\n‚Ä¢ Todas as configura√ß√µes\n‚Ä¢ Cache do navegador limpo\n\nüÜï SISTEMA COMPLETAMENTE RESETADO!\n\nüîí Para acessar novamente as fun√ß√µes administrativas:\nAperte 2 vezes em "Ver Profissionais"');
                
                // Log detalhado da a√ß√£o administrativa
                console.log('üî• ADMIN ACTION: COMPLETE SYSTEM FORMAT');
                console.log('üìÖ Timestamp:', new Date().toISOString());
                console.log('üóëÔ∏è Data cleared: ALL');
                console.log('üíæ LocalStorage: COMPLETELY CLEARED');
                console.log('üîÑ System state: FULLY RESET');
                console.log('‚úÖ Format completed successfully');
                
            } catch (error) {
                console.error('‚ùå ERRO CR√çTICO na formata√ß√£o:', error);
                alert('‚ùå ERRO CR√çTICO ao formatar o sistema!\n\nTentando recupera√ß√£o autom√°tica...');
                
                // Tentativa de recupera√ß√£o for√ßada
                try {
                    localStorage.clear();
                    location.reload();
                } catch (recoveryError) {
                    console.error('‚ùå Falha na recupera√ß√£o:', recoveryError);
                    alert('‚ùå FALHA CR√çTICA!\n\nPor favor, feche e reabra o navegador para resetar completamente o sistema.');
                }
            }
        }

        // Professional management
        function openProfessionalModal() {
            if (!userPermissions.canEdit) {
                alert('‚ùå Acesso negado!\n\nVoc√™ n√£o tem permiss√£o para cadastrar profissionais.');
                return;
            }
            document.getElementById('professionalModal').classList.add('active');
        }

        function closeProfessionalModal() {
            document.getElementById('professionalModal').classList.remove('active');
            document.getElementById('professionalForm').reset();
        }

        function openScheduleModal() {
            if (!userPermissions.canEdit) {
                alert('‚ùå Acesso negado!\n\nVoc√™ n√£o tem permiss√£o para criar agendamentos.');
                return;
            }
            editingAppointmentId = null;
            document.getElementById('scheduleModalTitle').textContent = 'Novo Agendamento';
            document.getElementById('scheduleSubmitBtn').textContent = 'Agendar';
            document.getElementById('deleteAppointmentBtn').style.display = 'none';
            document.getElementById('scheduleModal').classList.add('active');
            // Set default date to today
            document.getElementById('scheduleDate').value = new Date().toISOString().split('T')[0];
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
            document.getElementById('scheduleForm').reset();
            editingAppointmentId = null;
        }

        // Smart Reschedule Functions
        function openRescheduleModal() {
            if (!userPermissions.canEdit) {
                alert('‚ùå Acesso negado!\n\nVoc√™ n√£o tem permiss√£o para reagendar agendamentos.');
                return;
            }
            document.getElementById('rescheduleModal').classList.add('active');
            resetRescheduleModal();
            populateAppointmentsForReschedule();
        }

        function closeRescheduleModal() {
            document.getElementById('rescheduleModal').classList.remove('active');
            resetRescheduleModal();
        }

        function resetRescheduleModal() {
            selectedAppointmentForReschedule = null;
            document.getElementById('rescheduleStep1').style.display = 'block';
            document.getElementById('rescheduleStep2').style.display = 'none';
            document.getElementById('rescheduleStep3').style.display = 'none';
            document.getElementById('resetRescheduleBtn').style.display = 'none';
            document.getElementById('rescheduleSearch').value = '';
            document.getElementById('rescheduleNewDate').value = '';
            document.getElementById('rescheduleNewTime').value = '';
            populateAppointmentsForReschedule();
        }

        function populateAppointmentsForReschedule() {
            const container = document.getElementById('appointmentsList');
            container.innerHTML = '';

            if (appointments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum agendamento encontrado.</p>';
                return;
            }

            // Sort appointments by date and time
            const sortedAppointments = [...appointments].sort((a, b) => {
                const dateA = new Date(a.date + 'T' + a.time);
                const dateB = new Date(b.date + 'T' + b.time);
                return dateA - dateB;
            });

            sortedAppointments.forEach(apt => {
                const professional = professionals.find(p => p.id === apt.professionalId);
                const date = new Date(apt.date + 'T00:00:00');
                const formattedDate = date.toLocaleDateString('pt-BR');
                const dayName = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'][date.getDay()];

                const appointmentDiv = document.createElement('div');
                appointmentDiv.className = 'suggestion-item p-3 border rounded-lg cursor-pointer hover:bg-gray-50';
                appointmentDiv.onclick = () => selectAppointmentForReschedule(apt);
                
                appointmentDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${apt.client}</div>
                            <div class="text-sm text-gray-600">
                                üìÖ ${formattedDate} (${dayName}) √†s ${apt.time}
                            </div>
                            <div class="text-sm text-blue-600">
                                üë®‚Äç‚öïÔ∏è ${professional ? professional.name : 'Profissional n√£o encontrado'}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${getServiceTypeName(apt.type)} ‚Ä¢ ${apt.duration} min
                            </div>
                        </div>
                        <div class="ml-3">
                            <span class="inline-block w-4 h-4 rounded ${serviceColors[apt.type] || 'bg-gray-400'}"></span>
                        </div>
                    </div>
                `;
                
                container.appendChild(appointmentDiv);
            });
        }

        function searchAppointmentsForReschedule() {
            const searchTerm = document.getElementById('rescheduleSearch').value.toLowerCase();
            const appointmentItems = document.querySelectorAll('#appointmentsList .suggestion-item');
            
            appointmentItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function selectAppointmentForReschedule(appointment) {
            selectedAppointmentForReschedule = appointment;
            
            // Show step 2
            document.getElementById('rescheduleStep1').style.display = 'none';
            document.getElementById('rescheduleStep2').style.display = 'block';
            document.getElementById('resetRescheduleBtn').style.display = 'block';
            
            // Set default new date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('rescheduleNewDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('rescheduleNewTime').value = appointment.time;
        }

        function checkRescheduleOptions() {
            if (!selectedAppointmentForReschedule) {
                alert('Erro: Nenhum agendamento selecionado.');
                return;
            }

            const newDate = document.getElementById('rescheduleNewDate').value;
            const newTime = document.getElementById('rescheduleNewTime').value;

            if (!newDate || !newTime) {
                alert('Por favor, preencha a nova data e hor√°rio.');
                return;
            }

            const originalProfessional = professionals.find(p => p.id === selectedAppointmentForReschedule.professionalId);
            
            // Check if original professional is available
            const isOriginalAvailable = checkProfessionalAvailabilityForReschedule(
                selectedAppointmentForReschedule.professionalId, 
                newDate, 
                newTime, 
                selectedAppointmentForReschedule.duration,
                selectedAppointmentForReschedule.id
            );

            // Find alternative professionals with same specialty
            const alternativeProfessionals = findAlternativeProfessionals(
                originalProfessional.specialty,
                newDate,
                newTime,
                selectedAppointmentForReschedule.duration,
                selectedAppointmentForReschedule.professionalId
            );

            // Find CLS alternatives for clinic flexibility
            const clsAlternatives = findCLSAlternatives(
                selectedAppointmentForReschedule.type,
                newDate,
                newTime,
                selectedAppointmentForReschedule.duration,
                selectedAppointmentForReschedule.professionalId
            );

            // Show results
            showRescheduleResults(isOriginalAvailable, alternativeProfessionals, clsAlternatives, newDate, newTime);
        }

        function checkProfessionalAvailability(professionalId, date, time, duration, excludeAppointmentId = null) {
            const professional = professionals.find(p => p.id === professionalId);
            if (!professional || professional.inactive) {
                return false;
            }

            // Check for conflicts
            const conflicts = findTimeConflicts(professionalId, date, time, duration, excludeAppointmentId);
            return conflicts.length === 0;
        }

        function checkProfessionalAvailabilityForReschedule(professionalId, date, time, duration, excludeAppointmentId = null) {
            const professional = professionals.find(p => p.id === professionalId);
            if (!professional || professional.inactive) {
                return false;
            }

            // Check for conflicts - all appointment types block availability
            const conflicts = findTimeConflictsForReschedule(professionalId, date, time, duration, excludeAppointmentId);
            return conflicts.length === 0;
        }

        function findTimeConflicts(professionalId, date, time, duration, excludeAppointmentId = null) {
            const newStartTime = new Date(date + 'T' + time);
            const newEndTime = new Date(newStartTime.getTime() + duration * 60000);

            return appointments.filter(apt => {
                if (apt.id === excludeAppointmentId) return false;
                if (apt.professionalId !== professionalId) return false;
                if (apt.date !== date) return false;

                const aptStartTime = new Date(apt.date + 'T' + apt.time);
                const aptEndTime = new Date(aptStartTime.getTime() + apt.duration * 60000);

                // Check for time overlap
                return (newStartTime < aptEndTime && newEndTime > aptStartTime);
            });
        }

        function findTimeConflictsForReschedule(professionalId, date, time, duration, excludeAppointmentId = null) {
            const newStartTime = new Date(date + 'T' + time);
            const newEndTime = new Date(newStartTime.getTime() + duration * 60000);

            return appointments.filter(apt => {
                if (apt.id === excludeAppointmentId) return false;
                if (apt.professionalId !== professionalId) return false;
                if (apt.date !== date) return false;

                // All appointment types block reagendamento - no exceptions
                const aptStartTime = new Date(apt.date + 'T' + apt.time);
                const aptEndTime = new Date(aptStartTime.getTime() + apt.duration * 60000);

                // Check for time overlap
                return (newStartTime < aptEndTime && newEndTime > aptStartTime);
            });
        }

        function findAlternativeProfessionals(specialty, date, time, duration, excludeProfessionalId) {
            return professionals.filter(prof => {
                if (prof.id === excludeProfessionalId) return false;
                if (prof.inactive) return false;
                if (prof.specialty !== specialty) return false;
                
                return checkProfessionalAvailabilityForReschedule(prof.id, date, time, duration);
            });
        }

        // Special function to find CLS professionals for clinic flexibility
        function findCLSAlternatives(originalAppointmentType, date, time, duration, excludeProfessionalId) {
            // Only allow CLS substitution for clinic appointments and case discussions
            if (originalAppointmentType !== 'clinica' && originalAppointmentType !== 'discussao') {
                return [];
            }

            return professionals.filter(prof => {
                if (prof.id === excludeProfessionalId) return false;
                if (prof.inactive) return false;
                if (prof.specialty !== 'Analista do Comportamento') return false;
                
                // Check if CLS professional can replace the appointment
                return checkCLSAvailabilityForSubstitution(prof.id, date, time, duration);
            });
        }

        function checkCLSAvailabilityForSubstitution(professionalId, date, time, duration) {
            const professional = professionals.find(p => p.id === professionalId);
            if (!professional || professional.inactive) {
                return false;
            }

            // Find conflicts for CLS professional
            const conflicts = findTimeConflictsForCLS(professionalId, date, time, duration);
            return conflicts.length === 0;
        }

        function findTimeConflictsForCLS(professionalId, date, time, duration) {
            const newStartTime = new Date(date + 'T' + time);
            const newEndTime = new Date(newStartTime.getTime() + duration * 60000);

            return appointments.filter(apt => {
                if (apt.professionalId !== professionalId) return false;
                if (apt.date !== date) return false;

                // CLS can replace their own CLS appointments for clinic needs
                // But cannot replace other types (bloqueio, deslocamento, etc.)
                if (apt.type === 'cls') {
                    return false; // CLS can be replaced by clinic needs
                }

                const aptStartTime = new Date(apt.date + 'T' + apt.time);
                const aptEndTime = new Date(aptStartTime.getTime() + apt.duration * 60000);

                // Check for time overlap with non-CLS appointments
                return (newStartTime < aptEndTime && newEndTime > aptStartTime);
            });
        }

        function checkForConflictsInSlot(hourAppointments) {
            // Check if any appointments in this hour slot have time conflicts
            for (let i = 0; i < hourAppointments.length; i++) {
                const appointment = hourAppointments[i];
                const conflicts = findTimeConflicts(
                    appointment.professionalId,
                    appointment.date,
                    appointment.time,
                    appointment.duration,
                    appointment.id
                );
                if (conflicts.length > 0) {
                    return true;
                }
            }
            return false;
        }

        function showRescheduleResults(isOriginalAvailable, alternatives, clsAlternatives, newDate, newTime) {
            const resultsContainer = document.getElementById('rescheduleResults');
            const originalProfessional = professionals.find(p => p.id === selectedAppointmentForReschedule.professionalId);
            const formattedDate = new Date(newDate + 'T00:00:00').toLocaleDateString('pt-BR');
            const dayName = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'][new Date(newDate + 'T00:00:00').getDay()];

            let resultsHTML = `
                <h4 class="text-lg font-semibold mb-3 text-gray-800">3. Op√ß√µes de reagendamento:</h4>
                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                    <div class="font-medium text-blue-800">üìã Reagendamento solicitado:</div>
                    <div class="text-sm text-blue-700">
                        ${selectedAppointmentForReschedule.client} ‚Ä¢ ${formattedDate} (${dayName}) √†s ${newTime}
                    </div>
                </div>
            `;

            if (isOriginalAvailable) {
                resultsHTML += `
                    <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-green-600 text-xl">‚úÖ</span>
                            <span class="font-semibold text-green-800">Profissional Original Dispon√≠vel</span>
                        </div>
                        <div class="text-sm text-green-700 mb-3">
                            üë®‚Äç‚öïÔ∏è ${originalProfessional.name} est√° dispon√≠vel no hor√°rio solicitado.
                        </div>
                        <button onclick="executeReschedule('${selectedAppointmentForReschedule.professionalId}')" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚úÖ Reagendar com ${originalProfessional.name.split(' ')[0]}
                        </button>
                    </div>
                `;
            } else {
                // Check what's blocking the original professional
                const conflicts = findTimeConflictsForReschedule(
                    selectedAppointmentForReschedule.professionalId, 
                    newDate, 
                    newTime, 
                    selectedAppointmentForReschedule.duration,
                    selectedAppointmentForReschedule.id
                );

                resultsHTML += `
                    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-red-600 text-xl">‚ùå</span>
                            <span class="font-semibold text-red-800">Profissional Original Indispon√≠vel</span>
                        </div>
                        <div class="text-sm text-red-700 mb-2">
                            üë®‚Äç‚öïÔ∏è ${originalProfessional.name} n√£o est√° dispon√≠vel no hor√°rio solicitado.
                        </div>
                `;

                if (conflicts.length > 0) {
                    resultsHTML += `
                        <div class="text-xs text-red-600 mb-3">
                            <strong>Conflito:</strong> ${conflicts[0].client} (${conflicts[0].time} - ${getServiceTypeName(conflicts[0].type)})
                        </div>
                    `;
                }

                resultsHTML += `</div>`;
            }

            if (alternatives.length > 0) {
                resultsHTML += `
                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-blue-600 text-xl">üîÑ</span>
                            <span class="font-semibold text-blue-800">Profissionais Alternativos Dispon√≠veis</span>
                        </div>
                        <div class="text-sm text-blue-700 mb-3">
                            Encontrados ${alternatives.length} profissional(is) da especialidade "${originalProfessional.specialty}" dispon√≠vel(is):
                        </div>
                        <div class="space-y-2">
                `;

                alternatives.forEach(prof => {
                    resultsHTML += `
                        <div class="flex justify-between items-center p-3 bg-white rounded border">
                            <div>
                                <div class="font-medium text-gray-800">üë®‚Äç‚öïÔ∏è ${prof.name}</div>
                                <div class="text-sm text-gray-600">${prof.specialty}</div>
                                ${prof.registration ? `<div class="text-xs text-gray-500">Registro: ${prof.registration}</div>` : ''}
                            </div>
                            <button onclick="executeReschedule('${prof.id}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded font-medium text-sm">
                                üîÑ Reagendar
                            </button>
                        </div>
                    `;
                });

                resultsHTML += `
                        </div>
                    </div>
                `;
            }

            // Show CLS alternatives if available
            if (clsAlternatives.length > 0) {
                resultsHTML += `
                    <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-green-600 text-xl">üîÑ</span>
                            <span class="font-semibold text-green-800">Op√ß√£o CLS - Flexibilidade da Cl√≠nica</span>
                        </div>
                        <div class="text-sm text-green-700 mb-3">
                            ‚úÖ <strong>Regra Especial:</strong> Profissionais CLS podem substituir seus hor√°rios de CLS para atender necessidades da cl√≠nica.
                            <br>
                            üìã Encontrados ${clsAlternatives.length} Analista(s) do Comportamento com CLS dispon√≠vel para substitui√ß√£o:
                        </div>
                        <div class="space-y-2">
                `;

                clsAlternatives.forEach(prof => {
                    // Find the CLS appointment that would be replaced
                    const clsAppointment = appointments.find(apt => 
                        apt.professionalId === prof.id && 
                        apt.date === newDate && 
                        apt.type === 'cls' &&
                        new Date(newDate + 'T' + apt.time) <= new Date(newDate + 'T' + newTime) &&
                        new Date(newDate + 'T' + apt.time).getTime() + apt.duration * 60000 > new Date(newDate + 'T' + newTime).getTime()
                    );

                    resultsHTML += `
                        <div class="flex justify-between items-center p-3 bg-white rounded border border-green-200">
                            <div>
                                <div class="font-medium text-gray-800">üë®‚Äç‚öïÔ∏è ${prof.name}</div>
                                <div class="text-sm text-gray-600">${prof.specialty}</div>
                                ${prof.registration ? `<div class="text-xs text-gray-500">Registro: ${prof.registration}</div>` : ''}
                                ${clsAppointment ? `<div class="text-xs text-green-600">‚ö†Ô∏è Substituir√° CLS √†s ${clsAppointment.time}</div>` : ''}
                            </div>
                            <button onclick="executeReschedule('${prof.id}')" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-medium text-sm">
                                üîÑ Usar CLS
                            </button>
                        </div>
                    `;
                });

                resultsHTML += `
                        </div>
                        <div class="mt-3 p-2 bg-green-100 rounded text-xs text-green-700">
                            <strong>üí° Como funciona:</strong> O hor√°rio de CLS ser√° substitu√≠do pelo atendimento cl√≠nico/discuss√£o, priorizando as necessidades da cl√≠nica.
                        </div>
                    </div>
                `;
            }

            if (alternatives.length === 0 && clsAlternatives.length === 0 && !isOriginalAvailable) {
                resultsHTML += `
                    <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-yellow-600 text-xl">‚ö†Ô∏è</span>
                            <span class="font-semibold text-yellow-800">Nenhuma Alternativa Encontrada</span>
                        </div>
                        <div class="text-sm text-yellow-700 mb-3">
                            N√£o h√° outros profissionais da especialidade "${originalProfessional.specialty}" dispon√≠veis no hor√°rio solicitado.
                            ${(selectedAppointmentForReschedule.type === 'clinica' || selectedAppointmentForReschedule.type === 'discussao') ? 
                                '<br><strong>Nota:</strong> Tamb√©m n√£o h√° Analistas do Comportamento com CLS dispon√≠vel para substitui√ß√£o.' : ''}
                        </div>
                        <div class="text-xs text-yellow-600">
                            <strong>Sugest√µes:</strong>
                            <ul class="list-disc list-inside mt-1">
                                <li>Tente um hor√°rio diferente</li>
                                <li>Verifique a disponibilidade em outros dias</li>
                                <li>Considere reagendar o conflito existente</li>
                                ${(selectedAppointmentForReschedule.type === 'clinica' || selectedAppointmentForReschedule.type === 'discussao') ? 
                                    '<li>Verifique se h√° Analistas com hor√°rios de CLS em outros hor√°rios</li>' : ''}
                            </ul>
                        </div>
                    </div>
                `;
            }

            resultsContainer.innerHTML = resultsHTML;
            
            // Show step 3
            document.getElementById('rescheduleStep2').style.display = 'none';
            document.getElementById('rescheduleStep3').style.display = 'block';
        }

        function executeReschedule(newProfessionalId) {
            if (!selectedAppointmentForReschedule) {
                alert('Erro: Nenhum agendamento selecionado.');
                return;
            }

            const newDate = document.getElementById('rescheduleNewDate').value;
            const newTime = document.getElementById('rescheduleNewTime').value;
            const newProfessional = professionals.find(p => p.id === newProfessionalId);
            const originalProfessional = professionals.find(p => p.id === selectedAppointmentForReschedule.professionalId);

            if (!newProfessional) {
                alert('Erro: Profissional n√£o encontrado.');
                return;
            }

            // Confirm the reschedule
            const originalDate = new Date(selectedAppointmentForReschedule.date + 'T00:00:00').toLocaleDateString('pt-BR');
            const newFormattedDate = new Date(newDate + 'T00:00:00').toLocaleDateString('pt-BR');
            
            let confirmMessage = `Confirmar reagendamento?\n\n`;
            confirmMessage += `üë§ Cliente: ${selectedAppointmentForReschedule.client}\n\n`;
            confirmMessage += `üìÖ DE: ${originalDate} √†s ${selectedAppointmentForReschedule.time}\n`;
            confirmMessage += `üë®‚Äç‚öïÔ∏è Com: ${originalProfessional.name}\n\n`;
            confirmMessage += `üìÖ PARA: ${newFormattedDate} √†s ${newTime}\n`;
            confirmMessage += `üë®‚Äç‚öïÔ∏è Com: ${newProfessional.name}\n\n`;
            
            if (newProfessionalId !== selectedAppointmentForReschedule.professionalId) {
                confirmMessage += `‚ö†Ô∏è ATEN√á√ÉO: O profissional ser√° alterado!`;
            }

            if (confirm(confirmMessage)) {
                // Check if this is a CLS substitution
                const clsAppointmentToReplace = appointments.find(apt => 
                    apt.professionalId === newProfessionalId && 
                    apt.date === newDate && 
                    apt.type === 'cls' &&
                    new Date(newDate + 'T' + apt.time) <= new Date(newDate + 'T' + newTime) &&
                    new Date(newDate + 'T' + apt.time).getTime() + apt.duration * 60000 > new Date(newDate + 'T' + newTime).getTime()
                );

                // Update the appointment
                const appointmentIndex = appointments.findIndex(apt => apt.id === selectedAppointmentForReschedule.id);
                if (appointmentIndex !== -1) {
                    appointments[appointmentIndex].date = newDate;
                    appointments[appointmentIndex].time = newTime;
                    appointments[appointmentIndex].professionalId = newProfessionalId;
                    
                    let rescheduleNote = `\n[REAGENDADO] ${new Date().toLocaleString('pt-BR')}: Movido de ${originalDate} ${selectedAppointmentForReschedule.time} (${originalProfessional.name}) para ${newFormattedDate} ${newTime} (${newProfessional.name})`;
                    
                    // If replacing a CLS appointment, remove it and add note
                    if (clsAppointmentToReplace) {
                        appointments = appointments.filter(apt => apt.id !== clsAppointmentToReplace.id);
                        rescheduleNote += `\n[CLS SUBSTITU√çDO] CLS de ${clsAppointmentToReplace.time} foi substitu√≠do para atender necessidade da cl√≠nica`;
                    }
                    
                    appointments[appointmentIndex].notes = (appointments[appointmentIndex].notes || '') + rescheduleNote;

                    // Save to localStorage
                    localStorage.setItem('appointments', JSON.stringify(appointments));

                    // Update UI
                    renderScheduleGrid();
                    renderProfessionalsList();

                    // Close modal and show success
                    closeRescheduleModal();
                    
                    let successMessage = `‚úÖ Reagendamento realizado com sucesso!\n\n${selectedAppointmentForReschedule.client} foi reagendado para ${newFormattedDate} √†s ${newTime} com ${newProfessional.name}.`;
                    
                    if (clsAppointmentToReplace) {
                        successMessage += `\n\nüîÑ CLS Substitu√≠do: O hor√°rio de CLS √†s ${clsAppointmentToReplace.time} foi substitu√≠do para atender a necessidade da cl√≠nica.`;
                    }
                    
                    alert(successMessage);
                } else {
                    alert('Erro: Agendamento n√£o encontrado para atualiza√ß√£o.');
                }
            }
        }

        // View management
        function showProfessionalsView() {
            // Handle admin access sequence
            handleProfessionalButtonClick();
            
            document.getElementById('weeklyView').style.display = 'none';
            document.getElementById('professionalsView').style.display = 'block';
            document.getElementById('roomsView').style.display = 'none';
            renderProfessionalsList();
        }

        function showWeeklyView() {
            document.getElementById('professionalsView').style.display = 'none';
            document.getElementById('roomsView').style.display = 'none';
            document.getElementById('weeklyView').style.display = 'block';
            renderScheduleGrid();
        }

        function showRoomsView() {
            document.getElementById('weeklyView').style.display = 'none';
            document.getElementById('professionalsView').style.display = 'none';
            document.getElementById('roomsView').style.display = 'block';
            
            // Always start with table view
            isTableView = true;
            updateViewButtons();
            renderRoomsList();
        }

        // Week navigation
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            updateCurrentWeekDisplay();
            renderScheduleGrid();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            updateCurrentWeekDisplay();
            renderScheduleGrid();
        }

        function updateCurrentWeekDisplay() {
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const startStr = currentWeekStart.toLocaleDateString('pt-BR', options);
            const endStr = endDate.toLocaleDateString('pt-BR', options);
            
            document.getElementById('currentWeek').textContent = `${startStr} - ${endStr}`;
        }

        // Schedule grid rendering
        function renderScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';

            // Create headers
            const timeHeader = document.createElement('div');
            timeHeader.className = 'time-label';
            timeHeader.textContent = 'Hor√°rio';
            grid.appendChild(timeHeader);

            const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            // Create time slots (8:00 to 18:00) - hourly only
            for (let hour = 8; hour <= 18; hour++) {
                const timeStr = `${hour.toString().padStart(2, '0')}:00`;
                
                // Time label
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = timeStr;
                grid.appendChild(timeLabel);

                // Day slots
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const slot = document.createElement('div');
                    slot.className = 'time-slot appointment-slot';
                    slot.onclick = () => openScheduleModalForSlot(dayIndex, timeStr);
                    
                    // Check for appointments in this slot
                    const slotDate = new Date(currentWeekStart);
                    slotDate.setDate(slotDate.getDate() + dayIndex);
                    const dateStr = slotDate.toISOString().split('T')[0];
                    
                    // Only show appointments if a professional is selected AND active
                    let hourAppointments = [];
                    if (selectedProfessionalId) {
                        // Check if selected professional is still active
                        const selectedProf = professionals.find(p => p.id === selectedProfessionalId);
                        if (selectedProf && !selectedProf.inactive) {
                            const filteredAppointments = appointments.filter(apt => apt.professionalId === selectedProfessionalId);
                            
                            // Find all appointments that start in this hour slot
                            hourAppointments = filteredAppointments.filter(apt => {
                                if (apt.date !== dateStr) return false;
                                const aptHour = parseInt(apt.time.split(':')[0]);
                                return aptHour === hour;
                            });
                        } else if (selectedProf && selectedProf.inactive) {
                            // Professional is inactive, clear the selection
                            setTimeout(() => {
                                clearProfessionalFilter();
                                alert(`‚ö†Ô∏è O profissional "${selectedProf.name}" est√° marcado como inativo.\n\nPara visualizar a agenda deste profissional, primeiro desmarque a op√ß√£o "Inativo" na lista de profissionais.`);
                            }, 100);
                        }
                    }
                    
                    if (hourAppointments.length > 0) {
                        // Check for conflicts in this hour slot
                        const hasConflicts = checkForConflictsInSlot(hourAppointments);
                        
                        // Show all appointments in this hour slot
                        slot.innerHTML = hourAppointments.map(appointment => {
                            const professional = professionals.find(p => p.id === appointment.professionalId);
                            const appointmentConflicts = findTimeConflicts(
                                appointment.professionalId,
                                appointment.date,
                                appointment.time,
                                appointment.duration,
                                appointment.id
                            );
                            const hasConflict = appointmentConflicts.length > 0;
                            
                            return `
                                <div class="text-xs font-medium text-white p-1 mb-1 rounded ${serviceColors[appointment.type] || 'bg-gray-500'} cursor-pointer hover:opacity-80 transition-opacity ${hasConflict ? 'conflict-highlight' : ''}" onclick="editAppointment('${appointment.id}')">
                                    ${hasConflict ? '‚ö†Ô∏è ' : ''}${appointment.time} - ${appointment.client}
                                    <br>
                                    <span class="text-xs opacity-90">${professional ? professional.name.split(' ')[0] : 'N/A'}</span>
                                    <br>
                                    <span class="text-xs opacity-75">${appointment.duration}min${hasConflict ? ' (CONFLITO)' : ''}</span>
                                </div>
                            `;
                        }).join('');
                        
                        // Add visual indicator for conflicted slots
                        if (hasConflicts) {
                            slot.classList.add('conflict-highlight');
                            slot.title = '‚ö†Ô∏è Conflito de hor√°rio detectado neste slot';
                        }
                        
                        // Override the slot click to prevent opening new appointment modal
                        slot.onclick = null;
                    }
                    
                    grid.appendChild(slot);
                }
            }
        }

        function openScheduleModalForSlot(dayIndex, timeStr) {
            const slotDate = new Date(currentWeekStart);
            slotDate.setDate(slotDate.getDate() + dayIndex);
            
            document.getElementById('scheduleDate').value = slotDate.toISOString().split('T')[0];
            document.getElementById('scheduleTime').value = timeStr;
            openScheduleModal();
        }

        function editAppointment(appointmentId) {
            if (!userPermissions.canEdit) {
                alert('‚ùå Acesso negado!\n\nVoc√™ n√£o tem permiss√£o para editar agendamentos.');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                alert('Agendamento n√£o encontrado.');
                return;
            }

            editingAppointmentId = appointmentId;
            
            // Update modal title and button
            document.getElementById('scheduleModalTitle').textContent = 'Editar Agendamento';
            document.getElementById('scheduleSubmitBtn').textContent = 'Salvar Altera√ß√µes';
            document.getElementById('deleteAppointmentBtn').style.display = 'block';
            
            // Fill form with appointment data
            document.getElementById('scheduleProfessional').value = appointment.professionalId;
            document.getElementById('scheduleType').value = appointment.type;
            document.getElementById('scheduleDate').value = appointment.date;
            document.getElementById('scheduleTime').value = appointment.time;
            document.getElementById('scheduleDuration').value = appointment.duration;
            document.getElementById('scheduleClient').value = appointment.client;
            document.getElementById('scheduleNotes').value = appointment.notes || '';
            
            // Open modal
            document.getElementById('scheduleModal').classList.add('active');
        }

        function deleteCurrentAppointment() {
            if (!userPermissions.canEdit) {
                alert('‚ùå Acesso negado!\n\nVoc√™ n√£o tem permiss√£o para excluir agendamentos.');
                return;
            }
            
            if (!editingAppointmentId) return;
            
            const appointment = appointments.find(apt => apt.id === editingAppointmentId);
            if (!appointment) {
                alert('Agendamento n√£o encontrado.');
                return;
            }
            
            const professional = professionals.find(p => p.id === appointment.professionalId);
            const professionalName = professional ? professional.name : 'Profissional desconhecido';
            
            const confirmMessage = `Tem certeza que deseja excluir este agendamento?\n\nüìÖ Data: ${new Date(appointment.date + 'T00:00:00').toLocaleDateString('pt-BR')}\n‚è∞ Hor√°rio: ${appointment.time}\nüë®‚Äç‚öïÔ∏è Profissional: ${professionalName}\nüë§ Cliente: ${appointment.client}\n\n‚ùå Esta a√ß√£o n√£o pode ser desfeita.`;
            
            if (confirm(confirmMessage)) {
                appointments = appointments.filter(apt => apt.id !== editingAppointmentId);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                closeScheduleModal();
                renderScheduleGrid();
                renderProfessionalsList(); // Update appointment count in professionals list
                
                alert('‚úÖ Agendamento exclu√≠do com sucesso!');
            }
        }

        // Professional management
        function updateProfessionalSelect() {
            const select = document.getElementById('scheduleProfessional');
            select.innerHTML = '<option value="">Selecione o profissional...</option>';
            
            // Only show active professionals in the schedule select
            professionals.filter(prof => !prof.inactive).forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.id;
                option.textContent = `${prof.name} - ${prof.specialty}`;
                select.appendChild(option);
            });
        }

        function searchProfessional() {
            const searchInput = document.getElementById('professionalSearch');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                selectedProfessionalId = null;
                document.getElementById('selectedProfessionalInfo').style.display = 'none';
                hideProfessionalDropdown();
            } else {
                // Check if currently selected professional is inactive
                if (selectedProfessionalId) {
                    const selectedProf = professionals.find(p => p.id === selectedProfessionalId);
                    if (selectedProf && selectedProf.inactive) {
                        // Clear selection if professional is inactive
                        selectedProfessionalId = null;
                        document.getElementById('selectedProfessionalInfo').style.display = 'none';
                        searchInput.value = '';
                        hideProfessionalDropdown();
                        renderScheduleGrid();
                        return;
                    }
                }
                
                // Show matching professionals in dropdown
                updateProfessionalDropdown(searchTerm);
            }
            
            renderScheduleGrid();
        }

        function showProfessionalDropdown() {
            const searchTerm = document.getElementById('professionalSearch').value.toLowerCase().trim();
            updateProfessionalDropdown(searchTerm);
        }

        function updateProfessionalDropdown(searchTerm = '') {
            const dropdown = document.getElementById('professionalDropdown');
            
            // Filter professionals based on search term (only active professionals)
            const matchingProfessionals = professionals.filter(p => 
                !p.inactive && (searchTerm === '' || p.name.toLowerCase().includes(searchTerm))
            );
            
            if (matchingProfessionals.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Populate dropdown
            dropdown.innerHTML = matchingProfessionals.map(prof => `
                <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0" 
                     onclick="selectProfessional('${prof.id}', '${prof.name}', '${prof.specialty}')">
                    <div class="font-medium text-gray-800">${prof.name}</div>
                    <div class="text-xs text-gray-500">${prof.specialty}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }

        function selectProfessional(id, name, specialty) {
            selectedProfessionalId = id;
            document.getElementById('professionalSearch').value = name;
            document.getElementById('selectedProfessionalName').textContent = `${name} - ${specialty}`;
            document.getElementById('selectedProfessionalInfo').style.display = 'block';
            hideProfessionalDropdown();
            renderScheduleGrid();
        }

        function hideProfessionalDropdown() {
            document.getElementById('professionalDropdown').style.display = 'none';
        }

        function clearProfessionalFilter() {
            selectedProfessionalId = null;
            document.getElementById('professionalSearch').value = '';
            document.getElementById('selectedProfessionalInfo').style.display = 'none';
            renderScheduleGrid();
        }

        function renderProfessionalsList() {
            const container = document.getElementById('professionalsList');
            const searchTerm = document.getElementById('professionalsSearchFilter')?.value.toLowerCase().trim() || '';
            container.innerHTML = '';

            if (professionals.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum profissional cadastrado ainda.</p>';
                updateProfessionalsResultsCounter(0, 0);
                return;
            }

            // Filter professionals by search term
            let filteredProfessionals = professionals;
            if (searchTerm) {
                filteredProfessionals = professionals.filter(prof => 
                    prof.name.toLowerCase().includes(searchTerm) ||
                    prof.specialty.toLowerCase().includes(searchTerm) ||
                    (prof.registration && prof.registration.toLowerCase().includes(searchTerm))
                );
            }

            if (filteredProfessionals.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-8">Nenhum profissional encontrado para "${searchTerm}".</p>`;
                updateProfessionalsResultsCounter(0, professionals.length);
                return;
            }

            // Group filtered professionals by specialty
            const specialtyGroups = {};
            filteredProfessionals.forEach(prof => {
                const specialty = prof.specialty || 'Sem Especialidade';
                if (!specialtyGroups[specialty]) {
                    specialtyGroups[specialty] = [];
                }
                specialtyGroups[specialty].push(prof);
            });

            // Update results counter
            updateProfessionalsResultsCounter(filteredProfessionals.length, professionals.length);

            // Render each specialty group
            Object.keys(specialtyGroups).sort().forEach(specialty => {
                const professionalsInSpecialty = specialtyGroups[specialty];
                
                // Create specialty section
                const specialtySection = document.createElement('div');
                specialtySection.className = 'mb-8';
                
                // Large specialty header box
                const specialtyHeader = document.createElement('div');
                specialtyHeader.className = 'bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6 rounded-lg shadow-xl mb-4';
                specialtyHeader.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-bold mb-2">${getSpecialtyIcon(specialty)} ${specialty}</h2>
                            <p class="text-blue-100 text-lg">${professionalsInSpecialty.length} profissional(is) cadastrado(s)</p>
                        </div>
                        <div class="text-5xl opacity-60">
                            ${getSpecialtyIcon(specialty)}
                        </div>
                    </div>
                `;
                
                // Professionals list in compact format
                const professionalsList = document.createElement('div');
                professionalsList.className = 'space-y-2';
                
                professionalsInSpecialty.forEach(prof => {
                    const isInactive = prof.inactive || false;
                    const appointmentCount = appointments.filter(apt => apt.professionalId === prof.id).length;
                    
                    const profItem = document.createElement('div');
                    profItem.className = `bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition-all ${isInactive ? 'opacity-60 bg-red-50 border-red-200' : 'hover:border-blue-300'}`;
                    
                    profItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <!-- Professional Info -->
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="font-bold text-lg ${isInactive ? 'text-gray-500' : 'text-gray-800'} cursor-pointer hover:text-blue-600 transition-colors" onclick="viewProfessionalSchedule('${prof.id}', '${prof.name}', '${prof.specialty}')">${prof.name}</h3>
                                    ${isInactive ? '<span class="bg-red-100 text-red-600 px-2 py-1 rounded-full text-xs font-medium">INATIVO</span>' : ''}
                                </div>
                                
                                <div class="flex items-center gap-6 text-sm text-gray-600">
                                    ${prof.registration ? `<span>üìã ${prof.registration}</span>` : ''}
                                    <span class="flex items-center gap-1">
                                        üìÖ <strong class="text-blue-600">${appointmentCount}</strong> agendamento(s)
                                    </span>
                                    ${userPermissions.canEdit ? `
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" ${isInactive ? 'checked' : ''} onchange="toggleProfessionalStatus('${prof.id}')" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                            <span class="text-red-600 font-medium">Inativo</span>
                                        </label>
                                    ` : isInactive ? `
                                        <span class="bg-red-100 text-red-600 px-2 py-1 rounded-full text-xs font-medium">INATIVO</span>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex items-center gap-2 ml-4">
                                <button onclick="viewProfessionalSchedule('${prof.id}', '${prof.name}', '${prof.specialty}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                    üìÖ Ver Agenda
                                </button>
                                ${userPermissions.canEdit ? `
                                    <button onclick="deleteProfessional('${prof.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors" title="Excluir profissional">
                                        üóëÔ∏è
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    professionalsList.appendChild(profItem);
                });
                
                specialtySection.appendChild(specialtyHeader);
                specialtySection.appendChild(professionalsList);
                container.appendChild(specialtySection);
            });
        }

        // Helper function to get specialty icons
        function getSpecialtyIcon(specialty) {
            const icons = {
                'Psic√≥logo': 'üß†',
                'Analista do Comportamento': 'üìä',
                'Fonoaudi√≥logo': 'üó£Ô∏è',
                'Terapeuta Ocupacional': 'ü§≤',
                'Supervisor': 'üë®‚Äçüíº',
                'Importado': 'üì•',
                'Sem Especialidade': 'üë®‚Äç‚öïÔ∏è'
            };
            return icons[specialty] || 'üë®‚Äç‚öïÔ∏è';
        }

        function viewProfessionalSchedule(id, name, specialty) {
            // Set the professional filter
            selectedProfessionalId = id;
            document.getElementById('professionalSearch').value = name;
            document.getElementById('selectedProfessionalName').textContent = `${name} - ${specialty}`;
            document.getElementById('selectedProfessionalInfo').style.display = 'block';
            
            // Switch to weekly view
            showWeeklyView();
            
            // Render the schedule with the selected professional
            renderScheduleGrid();
        }

        function toggleProfessionalStatus(professionalId) {
            if (!userPermissions.canEdit) {
                alert('‚ùå Acesso negado!\n\nVoc√™ n√£o tem permiss√£o para alterar status de profissionais.');
                return;
            }
            
            const professional = professionals.find(p => p.id === professionalId);
            if (!professional) {
                alert('Profissional n√£o encontrado.');
                return;
            }
            
            const currentStatus = professional.inactive || false;
            const newStatus = !currentStatus;
            const statusText = newStatus ? 'inativo' : 'ativo';
            
            if (confirm(`Tem certeza que deseja marcar "${professional.name}" como ${statusText}?\n\n${newStatus ? '‚ö†Ô∏è O profissional n√£o aparecer√° mais na agenda semanal e n√£o poder√° receber novos agendamentos.' : '‚úÖ O profissional voltar√° a aparecer na agenda semanal e poder√° receber novos agendamentos.'}`)) {
                professional.inactive = newStatus;
                
                // If marking as inactive and this professional is currently selected, clear the filter
                if (newStatus && selectedProfessionalId === professionalId) {
                    clearProfessionalFilter();
                    alert(`‚ö†Ô∏è Profissional "${professional.name}" foi marcado como inativo e removido da visualiza√ß√£o da agenda.\n\nPara ver a agenda deste profissional novamente, primeiro desmarque a op√ß√£o "Inativo".`);
                }
                
                // Save changes to localStorage
                localStorage.setItem('professionals', JSON.stringify(professionals));
                
                // Update all interface elements
                renderProfessionalsList();
                updateProfessionalSelect();
                renderScheduleGrid();
                
                if (!newStatus || selectedProfessionalId !== professionalId) {
                    alert(`‚úÖ Profissional "${professional.name}" marcado como ${statusText}!`);
                }
            }
        }

        function deleteProfessional(professionalId) {
            if (!userPermissions.canEdit) {
                alert('‚ùå Acesso negado!\n\nVoc√™ n√£o tem permiss√£o para excluir profissionais.');
                return;
            }
            
            const professional = professionals.find(p => p.id === professionalId);
            if (!professional) {
                alert('Profissional n√£o encontrado.');
                return;
            }
            
            const professionalAppointments = appointments.filter(apt => apt.professionalId === professionalId);
            
            let confirmMessage = `Tem certeza que deseja excluir o profissional "${professional.name}"?`;
            
            if (professionalAppointments.length > 0) {
                confirmMessage += `\n\nEste profissional possui ${professionalAppointments.length} agendamento(s) que tamb√©m ser√£o exclu√≠dos.`;
            }
            
            if (confirm(confirmMessage)) {
                // Remove professional and their appointments
                professionals = professionals.filter(p => p.id !== professionalId);
                appointments = appointments.filter(apt => apt.professionalId !== professionalId);
                
                // Save changes to localStorage
                localStorage.setItem('professionals', JSON.stringify(professionals));
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                // Clear professional filter if this professional was selected
                if (selectedProfessionalId === professionalId) {
                    clearProfessionalFilter();
                }
                
                // Update all interface elements
                renderProfessionalsList();
                updateProfessionalSelect();
                renderScheduleGrid();
                
                alert('Profissional exclu√≠do com sucesso!');
            }
        }

        // Form handlers
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            // Check for admin activation sequence (3 empty clicks)
            if (!username && !password) {
                loginAttempts++;
                if (loginAttempts >= 3) {
                    // Activate admin mode
                    const adminUser = users.find(u => u.username === 'admin');
                    if (adminUser) {
                        currentUser = adminUser;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        setUserPermissions(adminUser);
                        showMainInterface();
                        alert('üîì Modo Administrador Ativado!\n\nVoc√™ foi logado como administrador padr√£o.\n\n‚ö†Ô∏è Use com responsabilidade!');
                        loginAttempts = 0;
                        return;
                    }
                }
                alert(`üîê Sequ√™ncia de ativa√ß√£o admin: ${loginAttempts}/3\n\nClique mais ${3 - loginAttempts} vez(es) em "Entrar" sem preencher os campos.`);
                return;
            }
            
            // Reset login attempts on normal login attempt
            loginAttempts = 0;
            
            if (!username || !password) {
                alert('‚ùå Por favor, preencha usu√°rio e senha.');
                return;
            }
            
            if (login(username, password)) {
                // Login successful - handled in login function
                document.getElementById('loginForm').reset();
            } else {
                alert('‚ùå Usu√°rio ou senha incorretos!\n\nVerifique suas credenciais e tente novamente.');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        });

        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!isAdminUser) {
                alert('‚ùå Acesso negado!\n\nApenas administradores podem adicionar usu√°rios.');
                return;
            }
            
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const permission = document.getElementById('newUserPermission').value;
            
            if (!name || !username || !password || !permission) {
                alert('‚ùå Por favor, preencha todos os campos.');
                return;
            }
            
            if (username.length < 3) {
                alert('‚ùå O nome de usu√°rio deve ter pelo menos 3 caracteres.');
                return;
            }
            
            if (password.length < 4) {
                alert('‚ùå A senha deve ter pelo menos 4 caracteres.');
                return;
            }
            
            addUser(name, username, password, permission);
        });

        document.getElementById('professionalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!userPermissions.canEdit) {
                alert('‚ùå Acesso negado!\n\nVoc√™ n√£o tem permiss√£o para cadastrar profissionais.');
                return;
            }
            
            const professional = {
                id: Date.now().toString(),
                name: document.getElementById('profName').value,
                specialty: document.getElementById('profSpecialty').value,
                registration: document.getElementById('profRegistration').value
            };
            
            professionals.push(professional);
            localStorage.setItem('professionals', JSON.stringify(professionals));
            
            closeProfessionalModal();
            updateProfessionalSelect();
            renderProfessionalsList();
            
            alert('Profissional cadastrado com sucesso!');
        });

        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!userPermissions.canEdit) {
                alert('‚ùå Acesso negado!\n\nVoc√™ n√£o tem permiss√£o para criar ou editar agendamentos.');
                return;
            }
            
            const appointmentData = {
                professionalId: document.getElementById('scheduleProfessional').value,
                type: document.getElementById('scheduleType').value,
                date: document.getElementById('scheduleDate').value,
                time: document.getElementById('scheduleTime').value,
                duration: parseInt(document.getElementById('scheduleDuration').value),
                client: document.getElementById('scheduleClient').value,
                notes: document.getElementById('scheduleNotes').value
            };
            
            // Check for conflicts before saving
            const conflicts = findTimeConflicts(
                appointmentData.professionalId,
                appointmentData.date,
                appointmentData.time,
                appointmentData.duration,
                editingAppointmentId
            );

            if (conflicts.length > 0) {
                const professional = professionals.find(p => p.id === appointmentData.professionalId);
                const isEditing = editingAppointmentId !== null;
                
                // Show detailed conflict resolution dialog
                showConflictResolutionDialog(conflicts, appointmentData, professional, isEditing);
                return;
            }
            
            if (editingAppointmentId) {
                // Update existing appointment
                const appointmentIndex = appointments.findIndex(apt => apt.id === editingAppointmentId);
                if (appointmentIndex !== -1) {
                    appointments[appointmentIndex] = {
                        ...appointments[appointmentIndex],
                        ...appointmentData
                    };
                    alert('‚úÖ Agendamento atualizado com sucesso!');
                }
            } else {
                // Create new appointment
                const appointment = {
                    id: Date.now().toString(),
                    ...appointmentData
                };
                appointments.push(appointment);
                alert('‚úÖ Agendamento criado com sucesso!');
            }
            
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            closeScheduleModal();
            renderScheduleGrid();
        });

        // Export/Import functionality
        function exportToExcel() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
            document.getElementById('excelFile').value = '';
        }

        function downloadExcel() {
            try {
                if (appointments.length === 0) {
                    alert('N√£o h√° agendamentos para exportar.');
                    return;
                }

                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Group appointments by professional
                const professionalGroups = {};
                appointments.forEach(apt => {
                    const professional = professionals.find(p => p.id === apt.professionalId);
                    const profName = professional ? professional.name : 'Profissional Desconhecido';
                    
                    if (!professionalGroups[profName]) {
                        professionalGroups[profName] = [];
                    }
                    professionalGroups[profName].push(apt);
                });

                // Create a sheet for each professional
                Object.keys(professionalGroups).forEach(profName => {
                    const profAppointments = professionalGroups[profName];
                    
                    // Create weekly grid structure
                    const weeklyData = [];
                    
                    // Header row 1 - Professional name
                    weeklyData.push(['', profName, '', '', '', '', '', '']);
                    
                    // Header row 2 - Days of week (Monday to Sunday)
                    weeklyData.push(['Hor√°rio', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo']);
                    
                    // Time slots from 8:00 to 18:00
                    for (let hour = 8; hour <= 18; hour++) {
                        const timeStr = `${hour.toString().padStart(2, '0')}:00`;
                        const row = [timeStr, '', '', '', '', '', '', ''];
                        
                        // Fill appointments for each day of the week
                        profAppointments.forEach(apt => {
                            const aptDate = new Date(apt.date + 'T00:00:00');
                            const aptHour = parseInt(apt.time.split(':')[0]);
                            
                            // Check if appointment is in this hour slot
                            if (aptHour === hour) {
                                // Get day of week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)
                                const dayOfWeek = aptDate.getDay();
                                
                                // Convert to our column index (1 = Monday, 7 = Sunday)
                                let columnIndex;
                                if (dayOfWeek === 0) { // Sunday
                                    columnIndex = 7;
                                } else { // Monday (1) to Saturday (6)
                                    columnIndex = dayOfWeek;
                                }
                                
                                // Add appointment info to the cell
                                const appointmentText = `${apt.client} (${apt.duration}min)`;
                                if (row[columnIndex] === '') {
                                    row[columnIndex] = appointmentText;
                                } else {
                                    row[columnIndex] += '\n' + appointmentText;
                                }
                            }
                        });
                        
                        weeklyData.push(row);
                    }
                    
                    // Create worksheet
                    const ws = XLSX.utils.aoa_to_sheet(weeklyData);
                    
                    // Set column widths
                    ws['!cols'] = [
                        { wch: 8 },  // Hor√°rio
                        { wch: 15 }, // Segunda
                        { wch: 15 }, // Ter√ßa
                        { wch: 15 }, // Quarta
                        { wch: 15 }, // Quinta
                        { wch: 15 }, // Sexta
                        { wch: 15 }, // S√°bado
                        { wch: 15 }  // Domingo
                    ];
                    
                    // Merge cells for professional name (B1:H1)
                    ws['!merges'] = [{ s: { r: 0, c: 1 }, e: { r: 0, c: 7 } }];
                    
                    // Add sheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, profName.substring(0, 31)); // Excel sheet names max 31 chars
                });
                
                // Also create a summary sheet with all appointments
                const summaryData = appointments.map(apt => {
                    const professional = professionals.find(p => p.id === apt.professionalId);
                    const date = new Date(apt.date + 'T00:00:00');
                    const formattedDate = date.toLocaleDateString('pt-BR');
                    const dayName = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][date.getDay()];
                    
                    return {
                        'Data': formattedDate,
                        'Dia da Semana': dayName,
                        'Hor√°rio': apt.time,
                        'Profissional': professional ? professional.name : 'N/A',
                        'Especialidade': professional ? professional.specialty : 'N/A',
                        'Tipo de Atendimento': getServiceTypeName(apt.type),
                        'Cliente': apt.client,
                        'Dura√ß√£o (min)': apt.duration,
                        'Observa√ß√µes': apt.notes || ''
                    };
                });

                // Sort summary by date and time
                summaryData.sort((a, b) => {
                    const dateA = new Date(a.Data.split('/').reverse().join('-') + 'T' + a.Hor√°rio);
                    const dateB = new Date(b.Data.split('/').reverse().join('-') + 'T' + b.Hor√°rio);
                    return dateA - dateB;
                });

                const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                
                // Set column widths for summary
                summaryWs['!cols'] = [
                    { wch: 12 }, // Data
                    { wch: 12 }, // Dia da Semana
                    { wch: 8 },  // Hor√°rio
                    { wch: 25 }, // Profissional
                    { wch: 20 }, // Especialidade
                    { wch: 18 }, // Tipo de Atendimento
                    { wch: 20 }, // Cliente
                    { wch: 10 }, // Dura√ß√£o
                    { wch: 30 }  // Observa√ß√µes
                ];

                // Add summary sheet as first sheet
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Resumo Geral');
                
                const today = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
                const filename = `agenda_clinica_aba_${today}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                alert('Planilha exportada com sucesso!\n\nüìã Resumo Geral: Lista completa de agendamentos\nüë®‚Äç‚öïÔ∏è Abas por Profissional: Grade semanal individual');
                
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('Erro ao exportar arquivo. Verifique se h√° agendamentos cadastrados.');
            }
        }

        let tempImportData = null; // Store temporary import data

        function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo Excel.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let totalAppointments = 0;
                    let newProfessionals = [];
                    let newAppointments = [];
                    
                    // Process each sheet (each professional)
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Get professional name from cell B1
                        const nameCell = worksheet['B1'];
                        if (!nameCell || !nameCell.v || !nameCell.v.toString().trim()) {
                            console.log(`Pulando aba "${sheetName}" - sem nome na c√©lula B1`);
                            return; // Skip this sheet if no name in B1
                        }
                        
                        const professionalName = nameCell.v.toString().trim();
                        
                        // Skip if name is not a proper professional name
                        const invalidNames = ['hora', 'horas', 'dias', 'dia', 'segunda', 'ter√ßa', 'quarta', 'quinta', 'sexta', 's√°bado', 'domingo', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab', 'dom', 'hor√°rio', 'horario', 'agenda', 'cronograma', 'planilha'];
                        if (invalidNames.includes(professionalName.toLowerCase()) || professionalName.length < 3) {
                            console.log(`Pulando aba "${sheetName}" - nome inv√°lido: "${professionalName}"`);
                            return; // Skip this sheet if name is invalid
                        }
                        
                        // Check if professional exists, if not create new one
                        let professional = professionals.find(p => 
                            p.name.toLowerCase() === professionalName.toLowerCase()
                        );
                        
                        if (!professional) {
                            professional = {
                                id: `import_prof_${Date.now()}_${Math.random()}`,
                                name: professionalName,
                                specialty: 'Importado',
                                registration: ''
                            };
                            newProfessionals.push(professional);
                        }
                        
                        // Read days from row 2 (C2 to I2) - skip B2 as it's not used for days
                        const days = [];
                        const dayColumns = ['C', 'D', 'E', 'F', 'G', 'H', 'I']; // Monday to Sunday
                        dayColumns.forEach(col => {
                            const cellRef = col + '2';
                            const cell = worksheet[cellRef];
                            if (cell && cell.v) {
                                days.push(cell.v.toString());
                            } else {
                                days.push('');
                            }
                        });
                        
                        // Read time slots from B3 to B15
                        for (let row = 3; row <= 15; row++) {
                            const timeCell = worksheet['B' + row];
                            if (!timeCell || !timeCell.v) continue;
                            
                            let timeStr = timeCell.v.toString();
                            // Convert '13h' format to '13:00'
                            if (timeStr.includes('h')) {
                                timeStr = timeStr.replace('h', ':00');
                            }
                            // Ensure proper time format
                            if (!timeStr.includes(':')) {
                                timeStr += ':00';
                            }
                            
                            // Read appointments for each day (C3 to I15)
                            dayColumns.forEach((col, dayIndex) => {
                                const cellRef = col + row;
                                const cell = worksheet[cellRef];
                                
                                if (cell && cell.v && cell.v.toString().trim() !== '') {
                                    const cellValue = cell.v.toString().trim();
                                    
                                    // Skip if cell is marked as blocked (gray cells)
                                    if (cellValue.toLowerCase() === 'bloqueado' || 
                                        cellValue.toLowerCase() === 'blocked' ||
                                        cellValue === 'X' || cellValue === 'x') {
                                        return;
                                    }
                                    
                                    // Determine service type based on cell color or content
                                    let serviceType = 'clinica'; // default
                                    const cellStyle = cell.s;
                                    
                                    // Try to determine service type from content
                                    const content = cellValue.toLowerCase();
                                    if (content.includes('bloqueio') || content.includes('bloqueado') || content === 'x') {
                                        serviceType = 'bloqueio';
                                    } else if (content.includes('deslocamento')) {
                                        serviceType = 'deslocamento';
                                    } else if (content.includes('reuni√£o') || content.includes('reuniao')) {
                                        serviceType = 'reuniao';
                                    } else if (content.includes('treinamento')) {
                                        serviceType = 'treinamento';
                                    } else if (content.includes('an√°lise') || content.includes('analise')) {
                                        serviceType = 'analise';
                                    } else if (content.includes('discuss√£o') || content.includes('discussao')) {
                                        serviceType = 'discussao';
                                    } else if (content.includes('cls')) {
                                        serviceType = 'cls';
                                    } else if (content.includes('supervis√£o') || content.includes('supervisao')) {
                                        serviceType = 'supervisao';
                                    } else if (content.includes('orienta√ß√£o') || content.includes('orientacao')) {
                                        serviceType = 'orientacao';
                                    }
                                    
                                    // Determine duration based on content
                                    let duration = 60; // default 60 minutes
                                    if (content.includes('30min') || content.includes('30 min')) {
                                        duration = 30;
                                    }
                                    
                                    // Calculate date based on day index
                                    const appointmentDate = new Date();
                                    const currentDay = appointmentDate.getDay();
                                    const daysToAdd = dayIndex - (currentDay === 0 ? 6 : currentDay - 1);
                                    appointmentDate.setDate(appointmentDate.getDate() + daysToAdd);
                                    
                                    const appointment = {
                                        id: `import_${Date.now()}_${Math.random()}`,
                                        professionalId: professional.id,
                                        type: serviceType,
                                        date: appointmentDate.toISOString().split('T')[0],
                                        time: timeStr,
                                        duration: duration,
                                        client: cellValue,
                                        notes: `Importado da planilha - Aba: ${sheetName}`
                                    };
                                    
                                    newAppointments.push(appointment);
                                    totalAppointments++;
                                }
                            });
                        }
                    });
                    
                    // Store temporary data
                    tempImportData = {
                        professionals: newProfessionals,
                        appointments: newAppointments,
                        totalAppointments: totalAppointments
                    };
                    
                    // Show confirmation dialog
                    showImportConfirmation(newProfessionals.length, totalAppointments);
                    
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    alert('Erro ao processar o arquivo. Verifique se o formato est√° correto.');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function getServiceTypeCode(typeName) {
            const typeMap = {
                'Atendimento Cl√≠nica': 'clinica',
                'An√°lise': 'analise',
                'Discuss√£o de Caso': 'discussao',
                'CLS': 'cls',
                'Supervis√£o': 'supervisao',
                'Treinamento': 'treinamento',
                'Orienta√ß√£o Parental': 'orientacao'
            };
            return typeMap[typeName] || null;
        }

        function getServiceTypeName(type) {
            const names = {
                'clinica': 'Atendimento Cl√≠nica',
                'analise': 'An√°lise',
                'discussao': 'Discuss√£o de Caso',
                'cls': 'CLS',
                'supervisao': 'Supervis√£o',
                'treinamento': 'Treinamento',
                'orientacao': 'Orienta√ß√£o Parental',
                'reuniao': 'Reuni√£o',
                'bloqueio': 'Bloqueio',
                'deslocamento': 'Deslocamento'
            };
            return names[type] || type;
        }

        function showImportConfirmation(newProfessionalsCount, totalAppointments) {
            document.getElementById('newProfessionalsCount').textContent = newProfessionalsCount;
            document.getElementById('totalAppointmentsCount').textContent = totalAppointments;
            document.getElementById('importConfirmModal').classList.add('active');
            closeExportModal(); // Close the export modal
        }

        function confirmImport() {
            if (tempImportData) {
                // Add new professionals
                tempImportData.professionals.forEach(prof => {
                    if (!professionals.find(p => p.id === prof.id)) {
                        professionals.push(prof);
                    }
                });
                
                // Replace all appointments with imported ones
                appointments = tempImportData.appointments;
                
                // Save to localStorage
                localStorage.setItem('professionals', JSON.stringify(professionals));
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                // Update UI
                updateProfessionalSelect();
                renderProfessionalsList();
                renderScheduleGrid();
                
                // Clear temporary data
                tempImportData = null;
                
                // Close modal
                document.getElementById('importConfirmModal').classList.remove('active');
                
                alert('Dados importados com sucesso!');
            }
        }

        function cancelImport() {
            // Clear temporary data
            tempImportData = null;
            
            // Close modal
            document.getElementById('importConfirmModal').classList.remove('active');
            
            alert('Importa√ß√£o cancelada. Nenhum dado foi alterado.');
        }

        // Room Import Functions - Separa√ß√£o de Salas with Full Integration
        function importRoomsExcel() {
            const fileInput = document.getElementById('roomsExcelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo Excel "Separa√ß√£o de Salas".');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Check if "Planilha1" sheet exists
                    if (!workbook.SheetNames.includes('Planilha1')) {
                        alert('‚ùå Erro: A planilha "Separa√ß√£o de Salas" deve conter uma aba chamada "Planilha1".');
                        return;
                    }
                    
                    const worksheet = workbook.Sheets['Planilha1'];
                    
                    let newRoomSchedule = [];
                    let roomsFound = new Set();
                    let slotsProcessed = 0;
                    let occupanciesFound = 0;
                    let validationErrors = [];
                    let autoCorrections = [];
                    let scheduleConflicts = [];
                    let newProfessionals = [];
                    let updatedAppointments = [];
                    
                    // Read room names from A3 to A48
                    const roomNames = [];
                    for (let row = 3; row <= 48; row++) {
                        const cellRef = 'A' + row;
                        const cell = worksheet[cellRef];
                        if (cell && cell.v && cell.v.toString().trim() !== '') {
                            roomNames.push({
                                row: row,
                                name: cell.v.toString().trim()
                            });
                        }
                    }
                    
                    // Read time slots from B3 to B629
                    const timeSlots = [];
                    for (let row = 3; row <= 629; row++) {
                        const cellRef = 'B' + row;
                        const cell = worksheet[cellRef];
                        if (cell && cell.v !== undefined && cell.v !== null) {
                            let timeStr = '';
                            
                            // Handle different Excel time formats
                            if (typeof cell.v === 'number') {
                                // Excel stores time as decimal (0.75 = 18:00, 0.5 = 12:00, etc.)
                                const totalMinutes = Math.round(cell.v * 24 * 60);
                                const hours = Math.floor(totalMinutes / 60);
                                const minutes = totalMinutes % 60;
                                timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                            } else {
                                // Handle string formats
                                timeStr = cell.v.toString().trim();
                                
                                // Convert various time formats to HH:MM
                                if (timeStr.includes('h')) {
                                    timeStr = timeStr.replace('h', ':00');
                                }
                                if (!timeStr.includes(':') && timeStr.length <= 2) {
                                    timeStr += ':00';
                                }
                                
                                // Handle HH:MM:SS format - keep only HH:MM
                                if (timeStr.includes(':') && timeStr.split(':').length === 3) {
                                    const timeParts = timeStr.split(':');
                                    timeStr = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
                                }
                                
                                // Ensure proper HH:MM format
                                if (timeStr.includes(':') && timeStr.split(':').length === 2) {
                                    const timeParts = timeStr.split(':');
                                    timeStr = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
                                }
                            }
                            
                            // Only add valid times
                            if (timeStr && timeStr.match(/^\d{1,2}:\d{2}$/)) {
                                timeSlots.push({
                                    row: row,
                                    time: timeStr
                                });
                                slotsProcessed++;
                            }
                        }
                    }
                    
                    // Read day names from C1, E1, G1, I1, K1, M1
                    const dayColumns = [
                        { col: 'C', patientCol: 'C', professionalCol: 'D', day: 'Segunda', dayIndex: 1 },
                        { col: 'E', patientCol: 'E', professionalCol: 'F', day: 'Ter√ßa', dayIndex: 2 },
                        { col: 'G', patientCol: 'G', professionalCol: 'H', day: 'Quarta', dayIndex: 3 },
                        { col: 'I', patientCol: 'I', professionalCol: 'J', day: 'Quinta', dayIndex: 4 },
                        { col: 'K', patientCol: 'K', professionalCol: 'L', day: 'Sexta', dayIndex: 5 },
                        { col: 'M', patientCol: 'M', professionalCol: 'N', day: 'S√°bado', dayIndex: 6 }
                    ];
                    
                    // Get all registered patients (from appointments) and professionals
                    const registeredPatients = [...new Set(appointments.map(apt => apt.client.toLowerCase().trim()))];
                    const registeredProfessionals = professionals.map(prof => prof.name.toLowerCase().trim());
                    
                    // Helper function to find closest match (for auto-correction)
                    function findClosestMatch(name, registeredList) {
                        const nameLower = name.toLowerCase().trim();
                        
                        // Exact match
                        const exactMatch = registeredList.find(registered => registered === nameLower);
                        if (exactMatch) return exactMatch;
                        
                        // Fuzzy match - check for similar names (simple similarity)
                        for (const registered of registeredList) {
                            // Check if names are similar (contains or partial match)
                            if (registered.includes(nameLower) || nameLower.includes(registered)) {
                                return registered;
                            }
                            
                            // Check for common typos (simple Levenshtein-like check)
                            const similarity = calculateSimilarity(nameLower, registered);
                            if (similarity > 0.8) { // 80% similarity threshold
                                return registered;
                            }
                        }
                        
                        return null;
                    }
                    
                    // Simple similarity calculation
                    function calculateSimilarity(str1, str2) {
                        const longer = str1.length > str2.length ? str1 : str2;
                        const shorter = str1.length > str2.length ? str2 : str1;
                        
                        if (longer.length === 0) return 1.0;
                        
                        const editDistance = levenshteinDistance(longer, shorter);
                        return (longer.length - editDistance) / longer.length;
                    }
                    
                    // Levenshtein distance calculation
                    function levenshteinDistance(str1, str2) {
                        const matrix = [];
                        
                        for (let i = 0; i <= str2.length; i++) {
                            matrix[i] = [i];
                        }
                        
                        for (let j = 0; j <= str1.length; j++) {
                            matrix[0][j] = j;
                        }
                        
                        for (let i = 1; i <= str2.length; i++) {
                            for (let j = 1; j <= str1.length; j++) {
                                if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                                    matrix[i][j] = matrix[i - 1][j - 1];
                                } else {
                                    matrix[i][j] = Math.min(
                                        matrix[i - 1][j - 1] + 1,
                                        matrix[i][j - 1] + 1,
                                        matrix[i - 1][j] + 1
                                    );
                                }
                            }
                        }
                        
                        return matrix[str2.length][str1.length];
                    }
                    
                    // Helper function to get date for day of week
                    function getDateForDayOfWeek(dayIndex) {
                        const today = new Date();
                        const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
                        
                        // Convert our dayIndex (1 = Monday) to JavaScript dayIndex (1 = Monday)
                        let daysToAdd = dayIndex - currentDay;
                        
                        // If the target day is in the past this week, move to next week
                        if (daysToAdd < 0) {
                            daysToAdd += 7;
                        }
                        
                        const targetDate = new Date(today);
                        targetDate.setDate(today.getDate() + daysToAdd);
                        return targetDate.toISOString().split('T')[0];
                    }
                    
                    // Process each day column
                    dayColumns.forEach(dayInfo => {
                        // Read day name from row 1
                        const dayCell = worksheet[dayInfo.col + '1'];
                        const dayName = dayCell && dayCell.v ? dayCell.v.toString().trim() : dayInfo.day;
                        const appointmentDate = getDateForDayOfWeek(dayInfo.dayIndex);
                        
                        // Process each row from 3 to 692 for this day
                        for (let row = 3; row <= 692; row++) {
                            // Find room name for this row (from A3-A48, repeating pattern)
                            const roomIndex = ((row - 3) % 46); // 46 rooms (A3 to A48)
                            const roomData = roomNames[roomIndex];
                            
                            if (!roomData) continue; // Skip if no room name
                            
                            const roomName = roomData.name;
                            roomsFound.add(roomName);
                            
                            // Find time for this row
                            const timeData = timeSlots.find(t => t.row === row);
                            if (!timeData) continue; // Skip if no time
                            
                            // Read patient name
                            const patientCell = worksheet[dayInfo.patientCol + row];
                            let patientName = patientCell && patientCell.v ? patientCell.v.toString().trim() : '';
                            let originalPatientName = patientName;
                            
                            // Read professional name
                            const professionalCell = worksheet[dayInfo.professionalCol + row];
                            let professionalName = professionalCell && professionalCell.v ? professionalCell.v.toString().trim() : '';
                            let originalProfessionalName = professionalName;
                            
                            // Skip empty rows
                            if (patientName === '' && professionalName === '') {
                                // Create empty room schedule entry
                                newRoomSchedule.push({
                                    id: `room_schedule_${Date.now()}_${Math.random()}_${row}_${dayInfo.col}`,
                                    roomName: roomName,
                                    time: timeData.time,
                                    dayOfWeek: dayName,
                                    isOccupied: false,
                                    patientName: '',
                                    professionalName: '',
                                    status: 'Sala Livre',
                                    importedAt: new Date().toISOString(),
                                    hasValidationError: false,
                                    wasAutoCorrected: false,
                                    linkedAppointmentId: null,
                                    hasScheduleConflict: false
                                });
                                continue;
                            }
                            
                            // Validate and auto-correct patient name
                            if (patientName !== '') {
                                const closestPatient = findClosestMatch(patientName, registeredPatients);
                                if (closestPatient) {
                                    // Find original case from appointments
                                    const originalPatient = appointments.find(apt => 
                                        apt.client.toLowerCase().trim() === closestPatient
                                    );
                                    if (originalPatient && originalPatient.client !== patientName) {
                                        autoCorrections.push({
                                            type: 'Paciente',
                                            original: originalPatientName,
                                            corrected: originalPatient.client,
                                            location: `${roomName} - ${dayName} ${timeData.time}`
                                        });
                                        patientName = originalPatient.client;
                                    }
                                } else {
                                    validationErrors.push({
                                        type: 'Paciente',
                                        name: originalPatientName,
                                        location: `${roomName} - ${dayName} ${timeData.time}`
                                    });
                                }
                            }
                            
                            // Validate and auto-correct professional name
                            let professionalId = null;
                            if (professionalName !== '') {
                                const closestProfessional = findClosestMatch(professionalName, registeredProfessionals);
                                if (closestProfessional) {
                                    // Find original case from professionals
                                    const originalProfessional = professionals.find(prof => 
                                        prof.name.toLowerCase().trim() === closestProfessional
                                    );
                                    if (originalProfessional) {
                                        professionalId = originalProfessional.id;
                                        if (originalProfessional.name !== professionalName) {
                                            autoCorrections.push({
                                                type: 'Profissional',
                                                original: originalProfessionalName,
                                                corrected: originalProfessional.name,
                                                location: `${roomName} - ${dayName} ${timeData.time}`
                                            });
                                            professionalName = originalProfessional.name;
                                        }
                                    }
                                } else {
                                    // Create new professional if not found
                                    const newProfessional = {
                                        id: `room_import_prof_${Date.now()}_${Math.random()}`,
                                        name: professionalName,
                                        specialty: 'Importado - Salas',
                                        registration: '',
                                        inactive: false
                                    };
                                    newProfessionals.push(newProfessional);
                                    professionalId = newProfessional.id;
                                    
                                    validationErrors.push({
                                        type: 'Profissional',
                                        name: originalProfessionalName,
                                        location: `${roomName} - ${dayName} ${timeData.time}`,
                                        action: 'Novo profissional ser√° criado'
                                    });
                                }
                            }
                            
                            // Check for existing appointments that match this room assignment
                            let linkedAppointmentId = null;
                            let hasScheduleConflict = false;
                            
                            if (professionalId && patientName !== '') {
                                // Look for existing appointment with same professional, patient, date, and time
                                const matchingAppointment = appointments.find(apt => 
                                    apt.professionalId === professionalId &&
                                    apt.client.toLowerCase().trim() === patientName.toLowerCase().trim() &&
                                    apt.date === appointmentDate &&
                                    apt.time === timeData.time
                                );
                                
                                if (matchingAppointment) {
                                    linkedAppointmentId = matchingAppointment.id;
                                    
                                    // Update appointment with room information
                                    const updatedAppointment = {
                                        ...matchingAppointment,
                                        roomName: roomName,
                                        notes: (matchingAppointment.notes || '') + `\n[SALA VINCULADA] ${new Date().toLocaleString('pt-BR')}: Sala ${roomName} vinculada via importa√ß√£o de Separa√ß√£o de Salas`
                                    };
                                    updatedAppointments.push(updatedAppointment);
                                } else {
                                    // Check for time conflicts with existing appointments
                                    const conflictingAppointments = appointments.filter(apt => 
                                        apt.professionalId === professionalId &&
                                        apt.date === appointmentDate &&
                                        apt.time === timeData.time
                                    );
                                    
                                    if (conflictingAppointments.length > 0) {
                                        hasScheduleConflict = true;
                                        scheduleConflicts.push({
                                            roomAssignment: `${roomName} - ${dayName} ${timeData.time}`,
                                            roomPatient: patientName,
                                            roomProfessional: professionalName,
                                            conflictingAppointments: conflictingAppointments.map(apt => ({
                                                client: apt.client,
                                                professional: professionals.find(p => p.id === apt.professionalId)?.name || 'Desconhecido',
                                                type: getServiceTypeName(apt.type)
                                            }))
                                        });
                                    }
                                }
                            }
                            
                            // Determine room status - occupied if either patient or professional is filled
                            const isOccupied = patientName !== '' || professionalName !== '';
                            
                            if (isOccupied) {
                                occupanciesFound++;
                            }
                            
                            // Create room schedule entry
                            newRoomSchedule.push({
                                id: `room_schedule_${Date.now()}_${Math.random()}_${row}_${dayInfo.col}`,
                                roomName: roomName,
                                time: timeData.time,
                                dayOfWeek: dayName,
                                appointmentDate: appointmentDate,
                                isOccupied: isOccupied,
                                patientName: patientName,
                                professionalName: professionalName,
                                professionalId: professionalId,
                                status: isOccupied ? 'Sala Ocupada' : 'Sala Livre',
                                importedAt: new Date().toISOString(),
                                hasValidationError: (originalPatientName !== '' && patientName === '') || 
                                                  (originalProfessionalName !== '' && professionalName === ''),
                                wasAutoCorrected: (originalPatientName !== patientName) || 
                                                (originalProfessionalName !== professionalName),
                                linkedAppointmentId: linkedAppointmentId,
                                hasScheduleConflict: hasScheduleConflict
                            });
                        }
                    });
                    
                    // Show comprehensive validation results
                    let validationMessage = '';
                    
                    if (newProfessionals.length > 0) {
                        validationMessage += `‚ûï NOVOS PROFISSIONAIS CRIADOS (${newProfessionals.length}):\n\n`;
                        newProfessionals.forEach(prof => {
                            validationMessage += `‚Ä¢ ${prof.name} (Especialidade: ${prof.specialty})\n`;
                        });
                        validationMessage += '\n';
                    }
                    
                    if (updatedAppointments.length > 0) {
                        validationMessage += `üîó AGENDAMENTOS VINCULADOS A SALAS (${updatedAppointments.length}):\n\n`;
                        updatedAppointments.forEach(apt => {
                            const prof = professionals.find(p => p.id === apt.professionalId) || newProfessionals.find(p => p.id === apt.professionalId);
                            validationMessage += `‚Ä¢ ${apt.client} com ${prof?.name || 'Profissional'} ‚Üí Sala ${apt.roomName}\n`;
                        });
                        validationMessage += '\n';
                    }
                    
                    if (scheduleConflicts.length > 0) {
                        validationMessage += `‚ö†Ô∏è CONFLITOS DE HOR√ÅRIO DETECTADOS (${scheduleConflicts.length}):\n\n`;
                        scheduleConflicts.forEach(conflict => {
                            validationMessage += `‚Ä¢ Sala: ${conflict.roomAssignment}\n`;
                            validationMessage += `  Paciente na sala: ${conflict.roomPatient}\n`;
                            validationMessage += `  Profissional na sala: ${conflict.roomProfessional}\n`;
                            validationMessage += `  Conflito com agendamento: ${conflict.conflictingAppointments[0].client} (${conflict.conflictingAppointments[0].professional})\n\n`;
                        });
                    }
                    
                    if (validationErrors.length > 0) {
                        validationMessage += `‚ùå ERROS DE VALIDA√á√ÉO (${validationErrors.length}):\n\n`;
                        validationErrors.forEach(error => {
                            validationMessage += `‚Ä¢ ${error.type}: "${error.name}" ${error.action || 'n√£o cadastrado'}\n  Local: ${error.location}\n\n`;
                        });
                    }
                    
                    if (autoCorrections.length > 0) {
                        validationMessage += `‚úÖ CORRE√á√ïES AUTOM√ÅTICAS (${autoCorrections.length}):\n\n`;
                        autoCorrections.forEach(correction => {
                            validationMessage += `‚Ä¢ ${correction.type}: "${correction.original}" ‚Üí "${correction.corrected}"\n  Local: ${correction.location}\n\n`;
                        });
                    }
                    
                    if (validationMessage !== '') {
                        alert(`üîç INTEGRA√á√ÉO E VALIDA√á√ÉO CONCLU√çDA\n\n${validationMessage}`);
                    }
                    
                    // Store temporary data
                    tempRoomImportData = {
                        schedule: newRoomSchedule,
                        newProfessionals: newProfessionals,
                        updatedAppointments: updatedAppointments,
                        roomsFound: roomsFound.size,
                        slotsProcessed: slotsProcessed,
                        occupanciesFound: occupanciesFound,
                        validationErrors: validationErrors.length,
                        autoCorrections: autoCorrections.length,
                        scheduleConflicts: scheduleConflicts.length,
                        linkedAppointments: updatedAppointments.length
                    };
                    
                    // Show confirmation dialog
                    showRoomImportConfirmation(roomsFound.size, slotsProcessed, occupanciesFound);
                    
                } catch (error) {
                    console.error('Erro ao importar Separa√ß√£o de Salas:', error);
                    alert('‚ùå Erro ao processar o arquivo "Separa√ß√£o de Salas".\n\nVerifique se o formato est√° correto:\n‚Ä¢ Arquivo deve ser "Separa√ß√£o de Salas.xlsx"\n‚Ä¢ Aba "Planilha1" deve existir\n‚Ä¢ Nomes das salas em A3:A48\n‚Ä¢ Hor√°rios em B3:B629\n‚Ä¢ Dias da semana em C1, E1, G1, I1, K1, M1\n‚Ä¢ Pacientes nas colunas C, E, G, I, K, M\n‚Ä¢ Profissionais nas colunas D, F, H, J, L, N');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function showRoomImportConfirmation(roomsFound, slotsProcessed, occupanciesFound) {
            // Verificar se h√° conflitos ou erros de valida√ß√£o que precisam ser revisados
            if (tempRoomImportData) {
                // Usar diretamente o modal de conflitos da IA interna
                document.getElementById('roomImportConfirmModal').classList.remove('active');
                confirmRoomImport();
            } else {
                // Fallback para o modal de confirma√ß√£o padr√£o
                document.getElementById('roomsFoundCount').textContent = roomsFound;
                document.getElementById('roomSlotsCount').textContent = slotsProcessed;
                document.getElementById('roomOccupanciesCount').textContent = occupanciesFound;
                document.getElementById('roomImportConfirmModal').classList.add('active');
                closeExportModal(); // Close the export modal
            }
        }

        function confirmRoomImport() {
            if (tempRoomImportData) {
                // Usar a IA interna para processar os dados antes de confirmar
                const processedData = internalAI.processImportedData(tempRoomImportData, professionals, appointments);
                
                // Mostrar o modal de conflitos da IA interna
                internalAI.showConflictsModal(
                    // Fun√ß√£o de callback para aceitar as altera√ß√µes
                    function() {
                        // 1. Add new professionals to the system
                        if (tempRoomImportData.newProfessionals.length > 0) {
                            tempRoomImportData.newProfessionals.forEach(prof => {
                                professionals.push(prof);
                            });
                        }
                        
                        // 2. Update existing appointments with room information
                        if (tempRoomImportData.updatedAppointments.length > 0) {
                            tempRoomImportData.updatedAppointments.forEach(updatedApt => {
                                const existingIndex = appointments.findIndex(apt => apt.id === updatedApt.id);
                                if (existingIndex !== -1) {
                                    appointments[existingIndex] = updatedApt;
                                }
                            });
                        }
                        
                        // 3. Replace room schedule data
                        roomSchedule = tempRoomImportData.schedule;
                        
                        // 4. Save all changes to localStorage
                        localStorage.setItem('professionals', JSON.stringify(professionals));
                        localStorage.setItem('appointments', JSON.stringify(appointments));
                        localStorage.setItem('roomSchedule', JSON.stringify(roomSchedule));
                        
                        // 5. Update all UI components
                        updateProfessionalSelect();
                        renderProfessionalsList();
                        renderScheduleGrid();
                        if (document.getElementById('roomsView').style.display !== 'none') {
                            renderRoomsList();
                        }
                    },
                    // Fun√ß√£o de callback para cancelar as altera√ß√µes
                    function() {
                        cancelRoomImport();
                    }
                );
                }
                
                // 6. Prepare success message
                let successMessage = `‚úÖ INTEGRA√á√ÉO COMPLETA REALIZADA COM SUCESSO!\n\n`;
                successMessage += `üè¢ ${tempRoomImportData.roomsFound} salas processadas\n`;
                successMessage += `üìÖ ${roomSchedule.length} hor√°rios importados\n`;
                successMessage += `üî¥ ${tempRoomImportData.occupanciesFound} ocupa√ß√µes registradas\n\n`;
                
                if (tempRoomImportData.newProfessionals.length > 0) {
                    successMessage += `‚ûï ${tempRoomImportData.newProfessionals.length} novo(s) profissional(is) criado(s)\n`;
                }
                
                if (tempRoomImportData.linkedAppointments > 0) {
                    successMessage += `üîó ${tempRoomImportData.linkedAppointments} agendamento(s) vinculado(s) a salas\n`;
                }
                
                if (tempRoomImportData.scheduleConflicts > 0) {
                    successMessage += `‚ö†Ô∏è ${tempRoomImportData.scheduleConflicts} conflito(s) de hor√°rio detectado(s)\n`;
                }
                
                if (tempRoomImportData.autoCorrections > 0) {
                    successMessage += `‚úÖ ${tempRoomImportData.autoCorrections} corre√ß√£o(√µes) autom√°tica(s) aplicada(s)\n`;
                }
                
                successMessage += `\nüí° Acesse "üè¢ Salas" para visualizar a ocupa√ß√£o completa.\n`;
                successMessage += `üìã Os profissionais e agendamentos foram atualizados automaticamente.`;
                
                // Clear temporary data
                const importStats = { ...tempRoomImportData };
                tempRoomImportData = null;
                
                // Close modal
                document.getElementById('roomImportConfirmModal').classList.remove('active');
                
                alert(successMessage);
            }
        }

        function cancelRoomImport() {
            // Clear temporary data
            tempRoomImportData = null;
            
            // Close modal
            document.getElementById('roomImportConfirmModal').classList.remove('active');
            
            alert('Importa√ß√£o de salas cancelada. Nenhum dado foi alterado.');
        }

        // Close modals and dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                // Don't close import confirmation modal by clicking outside
                if (e.target.id !== 'importConfirmModal' && e.target.id !== 'aiConflictModal' && e.target.id !== 'roomImportConfirmModal') {
                    e.target.classList.remove('active');
                }
            }
            
            // Close professional dropdown when clicking outside
            const searchInput = document.getElementById('professionalSearch');
            const dropdown = document.getElementById('professionalDropdown');
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                hideProfessionalDropdown();
            }
            
            // Close room filter dropdowns when clicking outside
            let clickedInsideDropdown = false;
            openDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                const button = dropdown?.previousElementSibling;
                
                if (dropdown && (dropdown.contains(e.target) || (button && button.contains(e.target)))) {
                    clickedInsideDropdown = true;
                }
            });
            
            if (!clickedInsideDropdown) {
                openDropdowns.forEach(dropdownId => {
                    document.getElementById(dropdownId).style.display = 'none';
                });
                openDropdowns.clear();
            }
        });

        // Initialize the application
        init();
    </script>
    
    <!-- Incluir o modal de conflitos da IA interna -->
    <div id="aiConflictModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>IA Interna - Conflitos Detectados</h2>
                <span class="close" onclick="document.getElementById('aiConflictModal').classList.remove('active')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="aiConflictDetails" class="p-4">
                    <!-- O conte√∫do ser√° preenchido dinamicamente pela IA interna -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="aiCancelChangesBtn" class="btn btn-secondary">Cancelar Altera√ß√µes</button>
                <button id="aiAcceptChangesBtn" class="btn btn-primary">Aceitar Altera√ß√µes</button>
            </div>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97717b6f267e248c',t:'MTc1NjUyNzQ4NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
